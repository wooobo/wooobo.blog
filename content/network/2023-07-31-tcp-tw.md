---
emoji: ğŸ”®
title: TCP_TW ì˜µì…˜?
date: '2023-07-31 00:00:00'
author: wooobo
tags: tcp
categories: í”„ë¡œê·¸ë˜ë°
---

# ê°œìš”?

ìµœê·¼ì— í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ, ë¦¬ëˆ…ìŠ¤ ì»¤ë„ë‹¨ì˜ ì„¤ì •ì— ì˜í•´ ì´ìŠˆê°€ ë°œìƒí•˜ì˜€ë‹¤.  
ê·¸ë˜ì„œ ì´ë²ˆ ê¸°íšŒì— TCP_TW ì„¤ì •ì— ëŒ€í•´ ì•Œì•„ë³´ê³ ì í•œë‹¤.

ì´ì „ì— ì´ìŠˆê°€ ëœ ì„¤ì •ì€ `tcp_tw_reuse`, `tcp_tw_recycle` ì˜µì…˜ì´ì—ˆëŠ”ë°, ì´ ì˜µì…˜ë“¤ì€ `TIME_WAIT` ìƒíƒœì˜ ì†Œì¼“ì„ ì¬ì‚¬ìš©í•˜ëŠ” ì˜µì…˜ì´ë‹¤.

# TIME_WAIT?
TIME_WAIT ìƒíƒœëŠ” TCP ì—°ê²°ì´ ì¢…ë£Œëœ í›„, ì¼ì • ì‹œê°„ ë™ì•ˆ ìœ ì§€ë˜ëŠ” ìƒíƒœì´ë‹¤.

# ì´ìŠˆ
ìµœê·¼ azure ì˜ `AKS`ë¥¼ ì„¸íŒ…í•˜ë©´ì„œ ì™¸ë¶€ ìš”ì²­ì— ëŒ€í•œ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•˜ëŠ” ì´ìŠˆê°€ ìˆì—ˆë‹¤.

## í™˜ê²½
- AKSì— í•˜ë‚˜ì˜ íŒŒë“œì— ë‘ê°œì˜ ì»¨í…Œì´ë„ˆë¥¼ ë„ìš´ ìƒíƒœ
- NAT ê²Œì´íŠ¸ì›¨ì´ë¥¼ ì‚¬ìš©

## ì´ìŠˆ ì‹œë‚˜ë¦¬ì˜¤
1. Aì»¨í…Œì´ë„ˆì—ì„œë§Œ ì™¸ë¶€APIë¥¼ í˜¸ì¶œí•˜ë©´ ë°”ë¡œë°”ë¡œ ì‘ë‹µì´ ì˜´
2. Bì»¨í…Œì´ë„ˆì—ì„œë§Œ ì™¸ë¶€APIë¥¼ í˜¸ì¶œí•˜ë©´ ë°”ë¡œë°”ë¡œ ì‘ë‹µì´ ì˜´
3. Aì»¨í…Œì´ë„ˆì—ì„œ ì™¸ë¶€APIí˜¸ì¶œ í›„ ë°”ë¡œ Bì»¨í…Œì´ë„ˆì—ì„œ  ì™¸ë¶€APIë¥¼ í˜¸ì¶œí•˜ë©´ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•¨

AKSì´ˆê¸° êµ¬ì„±ì‹œì—ëŠ” í•´ë‹¹ í˜„ìƒì´ ë°œìƒí•˜ì§€ ì•Šì•˜ì—ˆë‹¤.
ê·¸ëŸ°ë°, ì–´ëŠ ìˆœê°„ í•´ë‹¹ í˜„ìƒì´ ë°œìƒí•˜ê¸° ì‹œì‘í–ˆë‹¤.

ì„œë²„ êµ¬ì¶•ì„ í•´ì£¼ë˜ ì¸í”„ë¼íŒ€ì—ì„œ "tcp_tw_reuse, tcp_tw_recycle" ì— ëŒ€í•œ ì„¸íŒ… ì´ìŠˆë•Œë¬¸ì— ë°œìƒí•œê²ƒì´ë¼ê³  í–ˆë‹¤.

[ì°¸ê³  ë¸”ë¡œê·¸](https://brunch.co.kr/@alden/3) í•´ë‹¹ ë¸”ë¡œê·¸ ë‚´ìš©ì—ì„œ NAT ë¥¼ ì‚¬ìš©í• ë•Œ `tcp_tw_recycle` ì„ í™œì„±í™”í•œ ì„œë²„ì— ì ‘ì†í• ê²½ìš° í•´ë‹¹ ì´ìŠˆê°€ ë°œìƒí•œë‹¤ê³  í–ˆë‹¤.  
ê·¸ë ‡ë‹¤, AKS ì´ˆê¸° ì„¸íŒ…ì—ì„œëŠ” ë°œìƒí•˜ì§€ ì•Šì•˜ì§€ë§Œ NATë¥¼ ì—°ê²°í•œ ìˆœê°„ ë°œìƒí•œê²ƒìœ¼ë¡œ ì¶”ì¸¡ì´ëœë‹¤.

# ì¬í˜„í•´ë³´ì
## Client / Server ë„ìš°ê¸°
- ë„ì»¤ë¡œ Client ì™€ Server ë¥¼ êµ¬ì¶•í•´ë³´ì

```shell

# ë„¤íŠ¸ì›Œí¬ ìƒì„±
docker network create tw-net

# ì„œë²„
docker run -d --name server_test --net tw-net -p 91:80 -it --privileged ubuntu:20.04
apt update
apt install nginx
service nginx start

# í´ë¼ì´ì–¸íŠ¸
docker run -d --name client_test --net tw-net -p 92:80 -it --privileged ubuntu:20.04

# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
apt-get install net-tools
apt-get install vim

```

## Client ì—ì„œ tcp_tw_reuse í™œì„±í™”í•˜ê¸°
1. Client -> Server í˜¸ì¶œí•´ë³´ê¸°
- Docker ë„¤íŠ¸ì›Œí¬ ìƒì—ì„œ Server IPë¥¼ í™•ì¸í•˜ì.
```shell
$ docker network inspect tw-net
...

"Containers": {
    "4e879dc9a3e1ced91553d6464d98361ab639bb229d21780234f254c9ab2e8763": {
        "Name": "client_test",
        "EndpointID": "aff17140447ea02482cf5dd79ee032bfc26ce5d4bfbd643396b71a354a3e2008",
        "MacAddress": "02:42:ac:14:00:03",
        "IPv4Address": "172.20.0.3/16",
        "IPv6Address": ""
    },
    "911846c368f7419762ce537c1e002b5626b2f7a3953eec0addc945fac9914a6a": {
        "Name": "server_test",
        "EndpointID": "b0f83e1544bd7d1d7db17759324ea4b7018913c977e15f6b7fcd734bc1f54a41",
        "MacAddress": "02:42:ac:14:00:02",
        "IPv4Address": "172.20.0.2/16", <============ Server IP
        "IPv6Address": ""
    }
},
...
 ```

2. í˜¸ì¶œ í•´ë³´ì
```shell
root@4e879dc9a3e1:/# curl 172.20.0.2
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html> 
```

ì •ìƒì ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ”ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

3. ê³„ì† í˜¸ì¶œí•´ì„œ TIME_WAITë¥¼ í™•ì¸í•´ë³´ì
```shell
# 4ë²ˆ í˜¸ì¶œí›„ í™•ì¸ 
root@4e879dc9a3e1:/# netstat -n -t | grep 'TIME_WAIT'
tcp        0      0 172.20.0.3:42604        172.20.0.2:80           TIME_WAIT
tcp        0      0 172.20.0.3:42614        172.20.0.2:80           TIME_WAIT
tcp        0      0 172.20.0.3:42640        172.20.0.2:80           TIME_WAIT
tcp        0      0 172.20.0.3:42630        172.20.0.2:80           TIME_WAIT

```

ê°ê°ì˜ ë‹¤ë¥¸ í¬íŠ¸ë¡œ í˜¸ì¶œë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
> ê·¸ë ‡ë‹¤ë©´ í¬íŠ¸ë¥¼ í•˜ë‚˜ë¡œ ì¤„ì´ë©´ ì–´ë–»ê²Œ ë ê¹Œ? (í¬íŠ¸ë¥¼ ê³ ê°ˆì‹œì¼œë³´ì)

4. í¬íŠ¸ë¥¼ í•˜ë‚˜ë¡œ ì¤„ì—¬ì„œ í˜¸ì¶œí•´ë³´ì
```shell
# ì„¤ì • íŒŒì¼
vim /etc/sysctl.conf

# í•˜ë‹¨ì— ì¶”ê°€ 
net.ipv4.ip_local_port_range = 32768 32768

# ë³€ê²½ ë‚´ìš© ì ìš©
sysctl -p

# í˜¸ì¶œí•˜ê¸°
root@4e879dc9a3e1:/# curl 172.20.0.2
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
...

root@4e879dc9a3e1:/# curl 172.20.0.2
curl: (7) Couldn't connect to server
 
root@4e879dc9a3e1:/# netstat -n -t | grep 'TIME_WAIT'
tcp        0      0 172.20.0.3:32768        172.20.0.2:80           TIME_WAIT

```

- ë‘ë²ˆì§¸ í˜¸ì¶œì—ì„œ `curl: (7) Couldn't connect to server` ë°œìƒí•œë‹¤.

5.  ê·¸ë ‡ë‹¤ë©´, ì´ë•Œ `tcp_tw_reuse` ë¥¼ í™œì„±í™”í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?
```shell

# ì„¤ì • íŒŒì¼
vim /etc/sysctl.conf

# í•˜ë‹¨ì— ì¶”ê°€
net.ipv4.tcp_tw_reuse = 1

# ë³€ê²½ ë‚´ìš© ì ìš©
sysctl -p 

# ì—¬ëŸ¬ë²ˆ í˜¸ì¶œí•˜ê¸°
curl 172.20.0.2 

- ì •ìƒ í˜¸ì¶œë¨
```

## ê²°ë¡ 
- `tcp_tw_reuse` ë¥¼ í™œì„±í™”í•˜ë©´, TIME_WAIT ìƒíƒœì˜ í¬íŠ¸ë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- ìì„¸í•œ ë‚´ìš©ì€ https://cyuu.tistory.com/139 ì—¬ê¸°ë¥¼ ì°¸ê³ 

## tcp_tw_recycle!?

- tcp_tw_recycle ì€ Linux 4.12 on 2017 ì´í›„ ì œê±° ë˜ì—ˆë‹¤ê³  í•œë‹¤ ([ì°¸ê³ ](https://djangocas.dev/blog/troubleshooting-tcp_tw_recycle-no-such-file-or-directory/))
- docker ubuntu 20.04 ì—ì„œëŠ” `tcp_tw_recycle` ì„¤ì •ì´ ì—†ë‹¤. ê·¸ë˜ì„œ ë‹¤ë¥¸ ë¸”ë¡œê·¸ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•´ë³´ê¸¸ ë°”ë€ë‹¤.
  - [tcp_tw_reuseì™€ tcp_tw_recycle](https://brunch.co.kr/@alden/3) ì—¬ê¸° ë¸”ë¡œê·¸ë¥¼ ë³´ë©´ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í• ìˆ˜ìˆë‹¤.

# íšŒê³ 
ì²˜ìŒì— í•´ë‹¹ í˜„ìƒì´ ë°œìƒí–ˆì„ë•Œ, azureì˜ ë„¤íŠ¸ì›Œí¬ ì´ìŠˆì¸ì§€ ì•Œì•˜ë‹¤.  
ë‚˜ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì´ìŠˆë¥¼ ì°¾ì„ë ¤ê³  í–ˆë‹¤. ë‹¹ì—°íˆ ì°¾ì„ ìˆ˜ ê°€ ì—†ì—ˆë‹¤.  
ì´ë²ˆì˜ ê³„ê¸°ë¡œ ë‹¤ì–‘í•œ ë²”ìœ„ì—ì„œ ì´ìŠˆë¥¼ ì°¾ê¸°ìœ„í•œ ë…¸ë ¥ì´ í•„ìš”í•˜ë‹¤ëŠ”ê²ƒì„ ì•Œê²Œ ë˜ì—ˆë‹¤.  



## ì°¸ê³ 
- https://cyuu.tistory.com/139
- https://brunch.co.kr/@alden/