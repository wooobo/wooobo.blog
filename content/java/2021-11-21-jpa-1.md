---
emoji: ğŸ”®
title: JPA - í•™ìŠµí•˜ê¸°
date: '2021-11-21 00:00:00'
author: wooobo
tags: JPA
categories: í”„ë¡œê·¸ë˜ë°
---

<br> 

> í•™ìŠµëª©ì ìœ¼ë¡œ ì‘ì„±ë˜ì–´ ìƒëµëœ ë‚´ìš©ê³¼ ë‹¤ì†Œ ë¶€ì í™•í•œ ë‚´ìš©ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> ë‹¤ë£¨ëŠ” ë‚´ìš©  
> @Entity, Jpa ì—°ê´€ê´€ê³„, í¸ì˜ë©”ì†Œë“œ, @Embedded , @Embeddable

# ì˜ˆì œë¡œ ì‚¬ìš©í•´ë³¼ ê´€ê³„ë„

![img.png](../../assets/images/jpa-1.png)

`User(ìœ ì €)`í…Œì´ë¸” ê³¼ `Post(ê²Œì‹œë¬¼)` í…Œì´ë¸”ì´ ìˆìŠµë‹ˆë‹¤.
ì´ë•Œ `ìœ ì €`ëŠ” ì—¬ëŸ¬ê°œ ì˜ `ê²Œì‹œë¬¼`ì„ ì‘ì„± í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ìœ„ì˜ í…Œì´ë¸” êµ¬ì¡°ë¡œëŠ” `ìœ ì €`ê°€ ì‘ì„±í•œ `ê²Œì‹œë¬¼`ì´ ì–´ë–¤ê²ƒ ì¸ì§€ ì•Œìˆ˜ ì—†ìŠµë‹ˆë‹¤.  
ê·¸ë˜ì„œ ì´ë•Œ relation id ë¥¼ ë‘˜ì¤‘ í•˜ë‚˜ì˜ í…Œì´ë¸”ì— ì €ì¥ í•´ë‘ì–´ì•¼ í•©ë‹ˆë‹¤.

![img.png](../../assets/images/jpa-2.png)

í•œëª…ì˜ `User` ê°€ ì—¬ëŸ¬ê°œì˜ `Post` ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, `Post` í…Œì´ë¸”ì— ê´€ê³„ IDë¥¼ ì €ì¥í•˜ë„ë¡ ë³€ê²½í•©ë‹ˆë‹¤.
`Post` í…Œì´ë¸”ì— `user_id` ì»¬ëŸ¼ì€ `User` í…Œì´ë¸”ì˜ ê³ ìœ  `id`ì…ë‹ˆë‹¤.  

## ë°ì´í„°

- User í…Œì´ë¸”

|id|name|password|
|------|---|---|
|1|name1|pass1|
|2|name2|pass2|
|3|name3|pass3|

- Post í…Œì´ë¸”

|id|user_id|title|contents|
|------|---|---|
|1|3|ì œëª© 123|ë‚´ìš©|
|1|3|ì œëª© 748|ë‚´ìš©|
|2|1|ì œëª© 189|ë‚´ìš©|
|3|2|ì œëª© 1894|ë‚´ìš©|
|3|2|ì œëª© 181|ë‚´ìš©|

```sql

# user.id ê°€ "1" ì¸ post ì°¾ê¸° ì¿¼ë¦¬  
select post from post where post.user_id = 1;

# post í…Œì´ë¸”ì—ì„œ "post.user_id = 1" ì¡°ê±´ìœ¼ë¡œ user ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
select user from post join user on post.user_id = user.id where post.user_id = 1;

# user í…Œì´ë¸”ì—ì„œ "user.id = 1" ì¡°ê±´ìœ¼ë¡œ post ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
select post from user join post on user.id = post.user_id where user.id =1; 

```

DB ì—ì„œëŠ” í•œìª½ í…Œì´ë¸”ì—ì„œ Relation Id(ê´€ê³„ ID)ë¥¼ ê°€ì§€ê³  ìˆì–´ë„ ì–‘ë°©í–¥ ì¡°íšŒê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.    


## ê°ì²´ ê´€ì ì—ì„œ ë³´ê¸°


```java

@Entity
@Table(name = "user")
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "name", unique = true, length = 20, nullable = false)
    private String name;

    @Column(name = "password", length = 20, nullable = false)
    private String password;
    
    @OneToMany(mappedBy = "user")
    private List<Post> posts = new ArrayList<>();
    
    protected User() {
    }

    public User(String name, String password) {
        this.name = name;
        this.password = password;
    }

}

```

```java 


@Entity
@Table(name = "post")
public class Post {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "title", length = 100, nullable = false)
    String title;

    @Lob
    @Column(name = "contents")
    private String contents;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", foreignKey = @ForeignKey(name = "fk_post_user"))
    private User user;

    private Post() {
    }

    public Post( String title, String contents) {
        this.title = title;
        this.contents = contents;
    }
    
    public void toUser(User user) {
        this.user = user;
    }
}

```

ì•ì„œ DB ì—ì„œëŠ” ì–´ëŠ í•œìª½ì— ì—°ê´€ ID ë¥¼ ê°€ì§€ê³ ìˆìœ¼ë©´ ì–‘ë°©í–¥ìœ¼ë¡œ ì¡°íšŒê°€ë˜ëŠ”ê²ƒì„ í™•ì¸í–ˆì—ˆìŠµë‹ˆë‹¤.  
í•˜ì§€ë§Œ ê°ì²´ì…ì¥ì—ì„œëŠ” ì–‘ë°©í–¥ì´ë¼ëŠ” ê²ƒì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.  ë‹¨ë°©í–¥ë§Œ ì¡´ì¬ í•  ë¿ì…ë‹ˆë‹¤.
ì—¬ê¸°ì„œ ë‹¨ë°©í–¥ ê´€ê³„ë€, í•œìª½ì˜ Entity ì—ì„œë§Œ ì°¸ì¡° ë˜ê³ ìˆëŠ” ê²ƒì„ ë§í•©ë‹ˆë‹¤.  
ì–‘ë°©í–¥ ê´€ê³„ë€, ì–‘ìª½ Entity ì„œë¡œ ì°¸ì¡° ë˜ê³  ìˆëŠ” ê²ƒì„ ë§í•©ë‹ˆë‹¤.

ìœ„ì˜ Entity ì½”ë“œëŠ” `User` -> `Post` , `Post` -> `User` ì–´ëŠ Entity ì—ì„œë“  ì„œë¡œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ì–‘ë°©í–¥ ì°¸ì¡° ì¤‘ì…ë‹ˆë‹¤.

ì—°ê´€ ê´€ê³„ ì½”ë“œëŠ” ì•„ë˜ ë‘ ë¶€ë¶„ì…ë‹ˆë‹¤.

```java

** User entity
@OneToMany(mappedBy = "user")
private List<Post> posts = new ArrayList<>();


** Post entity
@ManyToOne(fetch = FetchType.LAZY) 
@JoinColumn(name = "user_id", foreignKey = @ForeignKey(name = "fk_post_user"))
private User user;

```

- `mappedBy` ì˜µì…˜ì€ ì£¼ì¸ í…Œì´ë¸”ì„ ì§€ì •í•´ì£¼ëŠ” ì—­í• í•©ë‹ˆë‹¤. Post entity ì—ì„œ ì„¤ì • ë˜ì–´ìˆëŠ” `user`ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
- `@JoinColumn` ìœ¼ë¡œ ì—°ê´€ ê´€ê³„ ì»¬ëŸ¼ì„ ì§€ì •í•©ë‹ˆë‹¤. ì—°ê´€ ê´€ê³„ ì»¬ëŸ¼ì€ `user_id`ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

ë§Œì•½ `User entity` ì—ì„œ `@OneToMany`ë¥¼ ì œê±° í•œë‹¤ë©´, `Post`->`User`ì˜ ë‹¨ë°©í–¥ ê´€ê³„ë¡œë§Œ ë§µí•‘ë©ë‹ˆë‹¤.  
ë³´í†µì€ ì²˜ìŒì—ëŠ” ëª¨ë‘ ë‹¨ë°©í–¥ ê´€ê³„ë¡œ ì„¤ê³„í–ˆë‹¤ê°€ í”„ë¡œì íŠ¸ê°€ ì§„í–‰í•˜ë©´ì„œ ì–‘ë°©í–¥ìœ¼ë¡œ ëš«ì–´ì•¼ í• ë•Œ ê·¸ë•Œ ì–‘ë°©í–¥ìœ¼ë¡œ í•˜ëŠ”ê²ƒì„ ì§€í–¥í•œë‹¤ê³  í•©ë‹ˆë‹¤.
 
> [í† í¬ON 41ì°¨. JPA í”„ë¡œê·¸ë˜ë° ê¸°ë³¸ê¸° ë‹¤ì§€ê¸° Tì•„ì¹´ë°ë¯¸](https://www.youtube.com/playlist?list=PL9mhQYIlKEhfpMVndI23RwWTL9-VL-B7U)  
> ì˜ìƒì„ í†µí•´ ìì„¸í•œ ê¸°ë³¸ ê°œë…ì„ ìµíˆëŠ”ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.  

## DDL ë¬¸ í™•ì¸í•˜ê¸°

sql ì¶œë ¥ ë¡œê·¸ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ Spring í”„ë¡œì íŠ¸ì˜ `application.properties` íŒŒì¼ì— ì•„ë˜ê°™ì´ ì„¤ì •í•©ë‹ˆë‹¤.  
H2 í…ŒìŠ¤íŠ¸ ë””ë¹„ì™€ , sql ì¶œë ¥ ì„¤ì •ì…ë‹ˆë‹¤.
```text
spring.datasource.url=jdbc:h2:~/test;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
spring.datasource.username=sa
spring.h2.console.enabled=true

spring.jpa.properties.hibernate.format_sql=true
spring.jpa.show-sql=true
logging.level.org.hibernate.type.descriptor.sql=trace
```

ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³ , DDL ë¬¸ ì¶œë ¥ ê²°ê³¼ì…ë‹ˆë‹¤.

```sql
create table post (
  id bigint generated by default as identity,
  contents clob,
  title varchar(100) not null,
  user_id bigint,
  primary key (id)
)

create table user (
  id bigint generated by default as identity,
  name varchar(20) not null,
  password varchar(20) not null,
  primary key (id)
)

# ìœ ë‹ˆí¬ ì„¤ì • SQL ì…ë‹ˆë‹¤.
alter table user 
  add constraint UK_gj2fy3dcix7ph7k8684gka40c unique (name)

# foregin key ì„¤ì •ì…ë‹ˆë‹¤. 
# `@JoinColumn(name = "user_id", foreignKey = @ForeignKey(name = "fk_post_user"))` ì„¤ì • ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ì¿¼ë¦¬ ì…ë‹ˆë‹¤.
alter table post 
  add constraint fk_post_user 
  foreign key (user_id) 
  references user
```
> JPA êµ³... ì–´ë…¸í…Œì´ì…˜ ë§µí•‘í–ˆì„ ë¿ì¸ë° DB ì— í•´ë‹¹ ë¶€ë¶„ì— ë§ì¶”ì–´ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤!

### Entity Test ì½”ë“œë¡œ í•˜ë‚˜ì”© ì§šì–´ë³´ê¸°

#### 1. ì–‘ë°©í–¥ ë§µí•‘ì‹œ ë¬´í•œë£¨í”„ ë¬¸ì œ

ì–‘ë°©í–¥ ë§µí•‘ì‹œ ë¬´í•œë£¨í”„ê°€ ë¬¸ì œê°€ ë°œìƒ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì½”ë“œ ë¶€í„° ë³´ê² ìŠµë‹ˆë‹¤. 

```java
@Test
void user_to_save_post() {
    // 1. new User
    User user = new User("name1", "PASSWORD!!");

    // 2. new Post
    Post post = new Post("ì œëª©", "ë‚´ìš©ì…ë‹ˆë‹¤.");
    post.toUser(user);
      
    // 3. user.addPost()
    user.addPost(post);

    // 4. post.getUser()
    System.out.println(post.getUser()); // ë¬´í•œ ë£¨í”„ ë°œìƒ 
}


# ì½˜ì†” ë¡œê·¸ 
java.lang.StackOverflowError
	at com.example.jpaexamples.domain.User.toString(User.java:59)
	at java.base/java.lang.String.valueOf(String.java:2951)
	at com.example.jpaexamples.domain.Post.toString(Post.java:57)
	at java.base/java.lang.String.valueOf(String.java:2951)
	at java.base/java.lang.StringBuilder.append(StringBuilder.java:168)
	at java.base/java.util.AbstractCollection.toString(AbstractCollection.java:473)
	at java.base/java.lang.String.valueOf(String.java:2951)
```

`post.getUser()` ë¥¼ ì¶œë ¥í•˜ë ¤ëŠ”ë° `StackOverflowError`ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.  
ì´ìœ ëŠ” post -> user -> post -> user ê³„ì†í•´ì„œ ì°¸ì¡° ê°ì²´ë¥¼ ì°¾ìœ¼ë ¤ í•´ì„œ ë¬¸ì œê°€ ë°œìƒ í•œê²ƒìœ¼ë¡œ ë³´ì—¬ì§‘ë‹ˆë‹¤.  
ì´ë•Œì—ëŠ” `toString()` ë©”ì†Œë“œë¥¼ ìˆ˜ì •í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.  

```java

# User
    @Override
    public String toString() {
        return "User{" +
            "id=" + id +
            ", name='" + name + '\'' +
            ", password='" + password + '\'' +
            ", posts='" + posts + '\'' +  =========================> ì œê±°
            '}';
    }
    
# POST
    @Override
    public String toString() {
        return "Post{" +
            "id=" + id +
            ", title='" + title + '\'' +
            ", contents='" + contents + '\'' +
            ", user='" + user + '\'' +   ===========================> ì œê±°
            '}';
    }

```

#### 2. í¸ì˜ë©”ì†Œë“œ 


```java 
@Test
void í¸ì˜ë©”ì†Œë“œ_ì˜ˆì œ() {
    // 1. new User
    User user = new User("name1", "PASSWORD!!");

    // 2. new Post
    Post post = new Post("ì œëª©", "ë‚´ìš©ì…ë‹ˆë‹¤.");
    post.toUser(user);

    // 3. user.getPosts();
    System.out.println(user.getPosts());  ====> ê²°ê³¼ : []
}
```

`Post` ìƒì„±ìë¥¼ í†µí•´ `user`ì°¸ì¡° ê°ì²´ë¥¼ ì „ë‹¬í•´ì£¼ì—ˆìŠµë‹ˆë‹¤. `user.getPosts()` ì¶œë ¥ì€ [] ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.  
ë‹¹ì—°...í•˜ì§€ë§Œ í¸ì˜ë©”ì†Œë“œë¥¼ ì•Œì•„ë³´ê¸°ìœ„í•œ ì˜ˆì œì…ë‹ˆë‹¤. ã…    
ë³´ì‹œëŠ”ê²ƒê³¼ ê°™ì´ ê°ì²´ëŠ” ë‹¨ë°©í–¥ê°œë… ë°–ì— ì—†ìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ê°ì²´ì…ì¥ì—ì„œëŠ” ì–‘ë°©í–¥ ê´€ê³„ë¼ê¸° ë³´ë‹¤ëŠ” ì–‘ë°©í–¥ ê´€ê³„ì¸ê²ƒ ì²˜ëŸ¼ ë§Œë“¤ì–´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.

- í¸ì˜ ë©”ì†Œë“œ ë¦¬íŒ©í† ë§

```java 

@Entity
@Table(name = "post")
public class Post {
    ...
    
    public void toUser(User user) {
        user.addPost(this);
        this.user = user;
    }
    
    ...
```

`toUser` ë©”ì†Œë“œì— `user.addPost(this);` `user` ê°ì²´ì—ë„ ìì‹ (`post`)ì„ ì¶”ê°€í•´ì£¼ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•´ì¤ë‹ˆë‹¤. ì´ì œ `post.toUser(user)` ë©”ì†Œë“œë¥¼ í˜¸ì¶œ í•˜ê²Œ ë˜ë©´ `post` ê°ì²´ì—ë„ ì¶”ê°€ë˜ê³  `user` ê°ì²´ì—ë„ ì¶”ê°€í•˜ë„ë¡ í•´ì£¼ëŠ”ê²Œ `í¸ì˜ë©”ì†Œë“œ`ì…ë‹ˆë‹¤.

ìˆ˜ì • í›„ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë‹¤ì‹œ ì‹¤í–‰ í•´ë³´ë©´ `user` ê°ì²´ì—ë„ ì¶”ê°€ëœê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```shell
// 3. user.getPosts();
System.out.println(user.getPosts()); // [Post{id=null, title='ì œëª©', contents='ë‚´ìš©ì…ë‹ˆë‹¤.'}]
```

### JpaRepository Test 

ì´ì œëŠ” JpaRepository í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ insert, select í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ë©° í•™ìŠµí•´ë³´ê² ìŠµë‹ˆë‹¤.
ê°„ë‹¨í•˜ê²Œ ì§šê³ ë§Œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤. `JpaRepository` ëŠ” Entity í´ë˜ìŠ¤ë¥¼ CRUD ë¿ë§Œ `Query Methods`ë¥¼ 
ì‚¬ìš©í•˜ì—¬ DB ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ì£¼ì–´ ì¶”ê°€,ì—…ë°ì´íŠ¸,ì‚­ì œë¥¼ ì†ì‰½ê²Œ ì‚¬ìš© í•  ìˆ˜ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.
(ë‹¤ìŒì— ìì„¸í•˜ê²Œ ë‹¤ë£¨ì–´ ë³´ê² ìŠµë‹ˆë‹¤..)

[Spring Data JPA ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#preface)


#### Entity ë ˆí¬ì§€í† ë¦¬ ë§Œë“¤ê¸°

ë³´í†µì€ `{Entity Name}Repository` ì˜ í˜•íƒœë¡œ ì´ë¦„ì„ ì •í•˜ê³ ,   
`public interface {Entity Name}Repository extends JpaRepository<T, ID>` ì˜ í˜•íƒœë¡œ ë ˆí¬ì§€í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```java
#  UserRepository
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByName(String name);
}

# PostRepository
public interface PostRepository extends JpaRepository<Post, Long> {
    Optional<Post> findByTitle(String title);
}
```

#### JPA í…ŒìŠ¤íŠ¸ í•˜ê¸°

`@DataJpaTest` ë¥¼ ì‚¬ìš©í•˜ë©´ ì†ì‰½ê²Œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

``` java
@DataJpaTest
public class RepositoryTest {

    @Autowired
    UserRepository userRepository;

    @Autowired
    PostRepository postRepository;

}
```


- User ìƒì„±

```java
@Test
void user_save() {
    User user = new User("name1", "PASSWORD!!"); // (1) ë¹„ì˜ì†
    userRepository.save(user); // (2) ì˜ì†
}

# ì¶œë ¥ SQL
Hibernate: 
    insert 
    into
        user
        (id, name, password) 
    values
        (null, ?, ?)
        
binding parameter [1] as [VARCHAR] - [name1]
binding parameter [2] as [VARCHAR] - [PASSWORD!!]
```

(1) ì€ ë¹„ì˜ì† ìƒíƒœë¡œ `entityManage` ì—ê²Œ ë§¤ë‹ˆì§• ë˜ê³  ìˆëŠ” ì•„ë‹Œ ìƒíƒœì…ë‹ˆë‹¤. (2) ì—ì„œ `save(entity)` ë¥¼ í˜¸ì¶œí•˜ê²Œ ë˜ë©´ 
DBì— `flush` í•˜ê²Œ ë˜ì–´ DB insert ê°€ ë³´ë‚´ì§€ê²Œ ë©ë‹ˆë‹¤.  
ì—¬ê¸°ì„œ ë§í•˜ëŠ” `ì˜ì†`, `ë¹„ì˜ì†`ì€ ì—”í‹°í‹° ìƒëª…ì£¼ê¸°ë¼ê³  í•˜ëŠ”ë°ìš”.  
ì—”í‹°í‹° ìƒëª…ì£¼ê¸°ì—ëŠ”
1. ë¹„ì˜ì†(new/transient): ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì „í˜€ ê´€ê³„ê°€ ì—†ëŠ” ìƒíƒœ
2. ì˜ì†(managed): ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ëœ ìƒíƒœ
3. ì¤€ì˜ì†(detached): ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì—ˆë‹¤ê°€ ë¶„ë¦¬ëœ ìƒíƒœ
4. ì‚­ì œ(removed): ì‚­ì œëœ ìƒíƒœ

ê·¸ëŸ¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ë­˜ê¹Œìš”... ã…œã…œ?  
ìš°ì„ ì€ ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸ ë¶€í„° ë³´ê² ìŠµë‹ˆë‹¤.

```shell
@Test
void user_update() {
    User user = new User("name1", "PASSWORD!!");
    System.out.println("log (1)");
    User savedUser = userRepository.save(user);
    
    System.out.println("log (2)");
    savedUser.setName("ì´ë¦„ ë³€ê²½");
    
    System.out.println("log (3)");
    userRepository.flush();
}

# log 
log (1)
Hibernate: 
    insert 
    into
        user
        (id, name, password) 
    values
        (null, ?, ?)
log (2)
log (3)
Hibernate: 
    update
        user 
    set
        name=?,
        password=? 
    where
        id=?
```

log ì°íŒê±¸ ë³´ë©´,   
`User savedUser = userRepository.save(user);` ìœ¼ë¡œ í†µí•´ `insert query` ê°€ commit ë©ë‹ˆë‹¤.  
ì´ë•Œ `savedUser` ëŠ” ì˜ì†ì„±ì„ ê°€ì§€ëŠ” ê°ì²´ì…ë‹ˆë‹¤.  
`savedUser.setName("ì´ë¦„ ë³€ê²½")` ë°˜ì‘ì—†ê³ ,   
`userRepository.flush()` ì—ì„œ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ê°€ commit ë©ë‹ˆë‹¤.    
`savedUser`ëŠ” ì—”í‹°í‹°ë§¤ë‹ˆì ¸(ì˜ì†ì»¨í…ìŠ¤íŠ¸)ì— ì˜í•´ ê´€ë¦¬ ë˜ê³  ìˆëŠ” ìƒíƒœì…ë‹ˆë‹¤.   
ê·¸ë˜ì„œ ì»¤ë°‹ ì‹œì ì— ë³€ê²½ëœ ë¶€ë¶„ì´ ìˆìœ¼ë©´ í•´ë‹¹ ë¶€ë¶„ì„ DB ì— ë°˜ì˜ì‹œí‚¤ëŠ” ì¿¼ë¦¬ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.  

ë” ìì„¸í•œ ì„¤ëª…ì€...  
![img.png](../../assets/images/ì˜¤ëŠ˜ì€ì—¬ê¸°ê¹Œì§€.png)  
ìì„¸í•œ ì„¤ëª…ì€ ì˜ ì •ë¦¬ëœ ë¸”ë¡œê·¸ ë§í¬ë¡œ ëŒ€ì²´í•˜ê² ìŠµë‹ˆë‹¤. [ë§í¬](https://siyoon210.tistory.com/138)


##### Post save

Post ë¥¼ ì €ì¥ í•´ë³´ê² ìŠµë‹ˆë‹¤. 

```java 
    @Test
    void save_post() {
        User user = new User("name1", "PASSWORD!!");
        Post post = new Post("title", "content", user);
        postRepository.save(post);
    }
```

í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ `org.hibernate.TransientPropertyValueException: Not-null property references a transient value ....` ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.

```java 
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", foreignKey = @ForeignKey(name = "fk_post_user"), nullable = false)
    private User user;
```

`@JoinColumn` ì„¤ì •ì—ì„œ `nullable = false` ì˜µì…˜ì„ ì¤¬ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— `Post` ì €ì¥ì‹œ `User` ëŠ” ì˜ì†(ì €ì¥ëœ) ìƒíƒœì—¬ì•¼í•©ë‹ˆë‹¤.

ìˆ˜ì •ëœ ì½”ë“œë¡œ ì‹¤í–‰í•˜ë©´

```java 

    @Test
    void save_post() {
        User user = userRepository.save(new User("name1", "PASSWORD!!"));// User save
        Post post = new Post("title", "content", user);
        postRepository.save(post);
    }
    
    
    # ë¡œê·¸
    
Hibernate: 
    insert 
    into
        user
        (id, name, password) 
    values
        (null, ?, ?)
 : binding parameter [1] as [VARCHAR] - [name1]
 : binding parameter [2] as [VARCHAR] - [PASSWORD!!]
Hibernate: 
    insert 
    into
        post
        (id, contents, title, user_id) 
    values
        (null, ?, ?, ?)
 : binding parameter [1] as [CLOB] - [content]
 : binding parameter [2] as [VARCHAR] - [title]
 : binding parameter [3] as [BIGINT] - [1]
```

`user_id` ê°€ [1] ë¡œ ë“¤ì–´ê°€ì§€ê³  ìˆëŠ”ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì´ë²ˆì—ëŠ”** `User` ë¥¼ í†µí•´ì„œ `Post`ë¥¼ ì €ì¥í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```java 
    @Test
    void save_user_post() {
        User user = new User("name1", "PASSWORD!!"); // User save
        Post post = new Post("title", "content");

        user.addPost(post);
        userRepository.save(user);
    }
    
    # ë¡œê·¸
    Hibernate: 
    insert 
    into
        user
        (id, name, password) 
    values
        (null, ?, ?)
```

í•˜ì§€ë§Œ, `Post`ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ìœ ëŠ” ì—°ê´€ê´€ê³„ ì£¼ì¸ì´ ì•„ë‹Œê³³ì—ì„œëŠ”(`mappedBy`) ì½ê¸°ë§Œ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. 
ì´ë•Œ ë‘ê°€ì§€ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.  
`í¸ì˜ë©”ì†Œë“œ`, `cascade ì˜µì…˜`

**1. í¸ì˜ ë©”ì†Œë“œ**

```java
  # User 
  public void addPost(Post post) {
      post.toUser(this);
      this.posts.add(post);
  }
    
  # í…ŒìŠ¤íŠ¸ ì½”ë“œ 
  user.addPost(post);
  userRepository.save(user);
  postRepository.save(post);
```

`user.addPoat(post)` í˜¸ì¶œì‹œ ë‚´ë¶€ì—ì„œ `post`ì—ê²Œë„ ì–‘ë°©í–¥ìœ¼ë¡œ ì ìš©í•´ì£¼ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  `post`ë¥¼ save() í•´ì£¼ì–´ì•¼í•©ë‹ˆë‹¤.

**2. Cascade ì˜µì…˜**

```java
    @OneToMany(mappedBy = "user", cascade = CascadeType.PERSIST)
    private List<Post> posts = new ArrayList<>();
```
`cascade = CascadeType.PERSIST` ì˜µì…˜ì„ ì¶”ê°€í•´ì£¼ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. 

```java 
    @Test
    void save_user_post() {
        User user = new User("name1", "PASSWORD!!"); // User save
        Post post = new Post("title", "content");

        user.addPost(post);
        userRepository.save(user);
    }
    
    # ë¡œê·¸
    Hibernate: 
    insert 
    into
        user
        (id, name, password) 
    values
        (null, ?, ?)
        
    Hibernate: 
    insert 
    into
        post
        (id, contents, title, user_id) 
    values
        (null, ?, ?, ?)
```

`userRepository.save(user);` í• ë•Œ, `id`ê°€ NULL ì´ë©´ ê°™ì´ ì €ì¥ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. 

>- CascadeType ì˜ ì¢…ë¥˜
   - CascadeType.RESIST â€“ ì—”í‹°í‹°ë¥¼ ìƒì„±í•˜ê³ , ì—°ê´€ ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•˜ì˜€ì„ ë•Œ persist() ë¥¼ ìˆ˜í–‰í•˜ë©´ ì—°ê´€ ì—”í‹°í‹°ë„ í•¨ê»˜ persist()ê°€ ìˆ˜í–‰ëœë‹¤.
   ë§Œì•½ ì—°ê´€ ì—”í‹°í‹°ê°€ DBì— ë“±ë¡ëœ í‚¤ê°’ì„ ê°€ì§€ê³  ìˆë‹¤ë©´ detached entity passed to persist Exceptionì´ ë°œìƒí•©ë‹ˆë‹¤.
   - CascadeType.MERGE â€“ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ê³  detach ìƒíƒœì—ì„œ ì—°ê´€ ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ë³€ê²½ëœ ì´í›„ì— ë¶€ëª¨ ì—”í‹°í‹°ê°€ merge()ë¥¼ ìˆ˜í–‰í•˜ê²Œ ë˜ë©´
   ë³€ê²½ì‚¬í•­ì´ ì ìš©ë¨(ì—°ê´€ ì—”í‹°í‹°ì˜ ì¶”ê°€ ë° ìˆ˜ì • ëª¨ë‘ ë°˜ì˜ë¨)
   - CascadeType.REMOVE â€“ ì‚­ì œ ì‹œ ì—°ê´€ëœ ì—”í‹°í‹°ë„ ê°™ì´ ì‚­ì œë¨
   - CascadeType.DETACH â€“ ë¶€ëª¨ ì—”í‹°í‹°ê°€ detach()ë¥¼ ìˆ˜í–‰í•˜ê²Œ ë˜ë©´, ì—°ê´€ëœ ì—”í‹°í‹°ë„ detach() ìƒíƒœê°€ ë˜ì–´ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ì§€ ì•ŠìŒ.
   - CascadeType.ALL â€“ ëª¨ë“  Cascade ì ìš©




#### @Embedded , @Embeddable

ì¢€ë” ê°ì²´ì§€í–¥ì  ê°œë°œì„ ìœ„í•´ ë°ì´í„°ë¥¼ ìƒíƒœì™€ í–‰ìœ„ë¥¼ ê°€ì§€ëŠ” ê°ì²´ë¡œ ì¶”ìƒí™” ì‹œì¼œë³´ê² ìŠµë‹ˆë‹¤.  
ì´ë•Œì— `@Embedded , @Embeddable`ë¥¼ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


```java 
@Embeddable
public class Posts {

    @OneToMany(mappedBy = "user", cascade = CascadeType.PERSIST)
    private List<Post> posts = new ArrayList<>();

    protected Posts() {

    }

    public void add(Post post, User writer) {
        post.toUser(writer);
        this.posts.add(post);
    }
}

```

```java 

@Entity
@Table(name = "user")
public class User {
    ...
      
    @Embedded
    private Posts posts = new Posts();
    
    public void addPost(Post post) {
        this.posts.add(post, this);
    }
    
    ...
```


`List<Post> posts` ì¼ê¸‰ì»¬ë ‰ì…˜ìœ¼ë¡œ `Posts`ë¡œ ë¶„ë¦¬í•˜ì˜€ê³  `@Embeddable`ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì˜€ìŠµë‹ˆë‹¤.  
ê·¸ë¦¬ê³ ,  ì‚¬ìš©ë˜ëŠ” `Entity` ì—ì„œëŠ”  `@Embedded` ìœ¼ë¡œ í™œìš©í•˜ì—¬ í•˜ë‚˜ì˜ `Entity`ì¸ê²ƒ ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


# ë§ˆë¬´ë¦¬

ë‹¤ë£¨ì–´ì•¼ ë  ë§ì€ ë‚´ìš©ì´ ì•„ì§ ë§ì§€ë§Œ, ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ëŠ”ê²ƒ ê°™ì•„ ì—¬ê¸°ì„œ ë§ˆë¬´ë¦¬ í•˜ê² ìŠµë‹ˆë‹¤.
ì¶”í›„ ë‚´ìš© ë³´ì™„ ë° ì¶”ê°€í•´ë³´ê² ìŠµë‹ˆë‹¤. 
ê°ì‚¬í•©ë‹ˆë‹¤.