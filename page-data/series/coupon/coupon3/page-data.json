{"componentChunkName":"component---src-templates-blog-template-js","path":"/series/coupon/coupon3/","result":{"data":{"cur":{"id":"e6e2a250-a57f-508a-baa0-4e560da46e5c","html":"<h2 id=\"레디스를-적용해보자\" style=\"position:relative;\"><a href=\"#%EB%A0%88%EB%94%94%EC%8A%A4%EB%A5%BC-%EC%A0%81%EC%9A%A9%ED%95%B4%EB%B3%B4%EC%9E%90\" aria-label=\"레디스를 적용해보자 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>레디스를 적용해보자</h2>\n<hr>\n<h2 id=\"시나리오\" style=\"position:relative;\"><a href=\"#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"시나리오 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>시나리오</h2>\n<p>1. Coupon 이 생성 될때, 발행갯수만큼 CouponTicket(userId가 null 상태)을 DB에 저장한다.</p>\n<p>2. 쿠폰 발급, CouponTicket의 ID를 Redis에 쌓는다.</p>\n<p>3. 쿠폰 배급 Redis에 쌓이 CouponTicket을 가져온다.</p>\n<ul>\n<li>\n<p>가져온 CouponTicket이 이미 userId가 정해져있는지 DB에 확인하고 정해져 있지 않다면 userId를 맵핑하고 저장한다.</p>\n</li>\n<li>\n<p>쿠폰티켓 결과를 반환해준다.</p>\n</li>\n</ul>\n<h3 id=\"구현\" style=\"position:relative;\"><a href=\"#%EA%B5%AC%ED%98%84\" aria-label=\"구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>구현</h3>\n<p>1. Coupon 이 생성 될때, 발행갯수만큼 CouponTicket(userId가 null 상태)을 DB에 저장한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponController</span> <span class=\"token punctuation\">{</span>\n\t\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    \n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"api/create\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        couponGenerateService<span class=\"token punctuation\">.</span><span class=\"token function\">generate</span><span class=\"token punctuation\">(</span>limit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token operator\">--</span><span class=\"token operator\">-</span>\n\n<span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponGenerateService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponGenerateService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponRepository <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponTicketRepository <span class=\"token operator\">=</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Coupon</span> coupon <span class=\"token operator\">=</span> <span class=\"token class-name\">Coupon</span><span class=\"token punctuation\">.</span><span class=\"token function\">limitOf</span><span class=\"token punctuation\">(</span>limit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>coupon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> couponTickets <span class=\"token operator\">=</span> coupon<span class=\"token punctuation\">.</span><span class=\"token function\">allPublish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span>couponTickets<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>2. 쿠폰 발급, CouponTicket의 ID를 Redis에 쌓는다.</p>\n<p>여러 방법이 있겠지만, 스케쥴러를 적용해보기로 했다.</p>\n<p>일정 갯수 이하일때 Redis에 쌓기.</p>\n<p><strong>Redis 설정하기</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${spring.data.redis.host}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> redisHost<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${spring.data.redis.port}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> redisPort<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisConnectionFactory</span> <span class=\"token function\">redisConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LettuceConnectionFactory</span><span class=\"token punctuation\">(</span>redisHost<span class=\"token punctuation\">,</span> redisPort<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">redisTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token function\">redisConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setKeySerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setValueSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">GenericJackson2JsonRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>스케쥴러 적용</strong></p>\n<ul>\n<li>1초에 한번씩 체크</li>\n<li>2000개 이하일때 10000개씩 밀어 넣게 구현</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponTicketRedisScheduler</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponTicketRedisScheduler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redisTemplate <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponTicketRepository <span class=\"token operator\">=</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Scheduled</span><span class=\"token punctuation\">(</span>fixedDelay <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Long</span> couponId <span class=\"token operator\">=</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">ListOperations</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> valueOperations <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Long</span> remainCount <span class=\"token operator\">=</span> valueOperations<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">generateCouponTicket</span><span class=\"token punctuation\">(</span>remainCount<span class=\"token punctuation\">,</span> couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"finished\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">generateCouponTicket</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> remainCount<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Pageable</span> page <span class=\"token operator\">=</span> <span class=\"token class-name\">Pageable</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> couponTickets <span class=\"token operator\">=</span> couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByCouponIdAndUserIdNull</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>remainCount <span class=\"token operator\">&lt;</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">ListOperations</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> valueOperations <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> couponTicketIds <span class=\"token operator\">=</span> couponTickets<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponTicket</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            valueOperations<span class=\"token punctuation\">.</span><span class=\"token function\">rightPushAll</span><span class=\"token punctuation\">(</span><span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> couponTicketIds<span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"couponTickets:\"</span> <span class=\"token operator\">+</span> couponId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>3. 쿠폰 배급 Redis에 쌓이 CouponTicket을 가져온다.</p>\n<p>- 컨트롤러</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"api/publish/{userId}/{couponId}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TicketDto</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">CouponTicket</span> couponTicket <span class=\"token operator\">=</span> couponTicketRedis<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>couponTicket <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TicketDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>couponTicket<span class=\"token punctuation\">.</span><span class=\"token function\">getCouponId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TicketDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>- Reids 에서 쿠폰 티켓 가져오기 서비스</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponTicketRedis</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponTicketRedis</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redisTemplate <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponTicketRepository <span class=\"token operator\">=</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponTicket</span> <span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ListOperations</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> valueOperations <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 티켓 POP</span>\n        <span class=\"token class-name\">CouponTicket</span> couponTicket <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">)</span> valueOperations<span class=\"token punctuation\">.</span><span class=\"token function\">leftPop</span><span class=\"token punctuation\">(</span><span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>couponTicket <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NoSuchElementException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"쿠폰이 존재하지 않습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 유저 세팅</span>\n        couponTicket<span class=\"token punctuation\">.</span><span class=\"token function\">owner</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 유저 세팅 후 저장</span>\n        couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>couponTicket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> couponTicket<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"couponTickets:\"</span> <span class=\"token operator\">+</span> couponId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"부하-테스트\" style=\"position:relative;\"><a href=\"#%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"부하 테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>부하 테스트</h2>\n<p>k6 부하 테스트</p>\n<p>- script.js</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token namespace\">http</span> from 'k6<span class=\"token operator\">/</span>http'<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>check<span class=\"token punctuation\">,</span> sleep<span class=\"token punctuation\">}</span> from <span class=\"token char\">'k6'</span><span class=\"token punctuation\">;</span>\n\nexport <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    stages<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>duration<span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> target<span class=\"token operator\">:</span> <span class=\"token number\">500</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>duration<span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> target<span class=\"token operator\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>duration<span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> target<span class=\"token operator\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>duration<span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> target<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    thresholds<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        http_req_duration<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>'<span class=\"token function\">p</span><span class=\"token punctuation\">(</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span><span class=\"token number\">100</span>'<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nexport <span class=\"token keyword\">default</span> function <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>`http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">:</span><span class=\"token number\">8080</span><span class=\"token operator\">/</span>api<span class=\"token operator\">/</span>publish<span class=\"token operator\">/</span>$<span class=\"token punctuation\">{</span><span class=\"token function\">getRandomInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">/</span><span class=\"token number\">2</span>`<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">check</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>'status was <span class=\"token number\">200</span>'<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> r<span class=\"token punctuation\">.</span>status <span class=\"token operator\">==</span><span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nfunction <span class=\"token function\">getRandomInt</span><span class=\"token punctuation\">(</span>min<span class=\"token punctuation\">,</span> max<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    min <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span>min<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    max <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>max <span class=\"token operator\">-</span> min<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> min<span class=\"token punctuation\">;</span> <span class=\"token comment\">//최댓값은 제외, 최솟값은 포함</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>테스트 결과</strong></p>\n<p><img src=\"../content/series/coupon/coupon-3-01.png\" alt=\"\"></p>\n<p>평균 100ms 이하로 나왔다.</p>\n<p>지연되는 부분은</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">        <span class=\"token comment\">// 유저 세팅 후 저장</span>\n        couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>couponTicket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"db-pool-size-조정해보면-어떨까\" style=\"position:relative;\"><a href=\"#db-pool-size-%EC%A1%B0%EC%A0%95%ED%95%B4%EB%B3%B4%EB%A9%B4-%EC%96%B4%EB%96%A8%EA%B9%8C\" aria-label=\"db pool size 조정해보면 어떨까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DB POOL SIZE 조정해보면 어떨까?</h2>\n<p>문득 DB 커넥션 POOL을 늘리면 빨라지지 좀 더 최적화 할 수 있지 않을까 생각이 되었다.</p>\n<p>설정을 추가했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">spring.datasource.hikari.maximum-pool-size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span></code></pre></div>\n<p>그리고 pool size 를 나누어 테스트 해보았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\"><span class=\"token title important\"><span class=\"token punctuation\">#</span> DB pool size 25</span>\navg=403.13ms min=2.63ms med=521.26ms max=999.98ms p(90)=712.01ms p(95)=755.75ms\navg=453.87ms min=2.79ms med=584.58ms max=1.17s   p(90)=808.83ms p(95)=942.38ms\navg=430.86ms min=2.79ms med=564.97ms max=1.24s    p(90)=861.28ms p(95)=947.41ms\n\n<span class=\"token title important\"><span class=\"token punctuation\">#</span> DB pool size 50</span>\navg=327.05ms min=2.65ms med=354.36ms max=1.62s   p(90)=634.81ms p(95)=1.07s\navg=167.88ms min=2.33ms med=192.51ms max=580.31ms p(90)=329.93ms p(95)=395.59ms\navg=229.95ms min=2.6ms  med=312.7ms  max=686.1ms  p(90)=431.14ms p(95)=460.81ms\n\n<span class=\"token title important\"><span class=\"token punctuation\">#</span> DB pool size 75</span>\navg=295.76ms min=3.05ms med=327.56ms max=927.11ms p(90)=614.81ms p(95)=676.6ms\n\n<span class=\"token title important\"><span class=\"token punctuation\">#</span> DB pool size 100</span>\navg=178.74ms min=2.55ms med=208.44ms max=560.36ms p(90)=342.46ms p(95)=376.09ms\navg=163.61ms min=2.71ms med=133.92ms max=626.94ms p(90)=374.09ms p(95)=451.05ms\navg=205.32ms min=1.11ms med=215.16ms max=708.67ms p(90)=426.21ms p(95)=503.23ms</code></pre></div>\n<p>나름 유의미한 결과가 나왔다.<br>\n현재 로컬 구조는 <code class=\"language-text\">docker Mysql</code>, <code class=\"language-text\">docker Redis</code>, <code class=\"language-text\">Local Spring boot Server</code> 이다.<br>\nPC는 맥북 에어 m2이다.</p>\n<p>현재 사양에서는 DB pool size 100 일때 가장 최적화된것으로 확인되었다.<br>\npool size 를 더 늘려보았지만, DB 사양 한계치가 있어서인지 그이상은 오히려 느려졌다.</p>\n<p><strong>서버 스레드 늘리면?</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">server.tomcat.threads.max=20\n\nDB pool size 50, tomcat threads 20\navg=464.32ms min=2.6ms  med=623.78ms max=882.89ms p(90)=821.75ms p(95)=838.93ms\navg=496.68ms min=2.68ms med=649.88ms max=987.8ms  p(90)=866.58ms p(95)=934.47ms\navg=539.1ms  min=2.77ms med=553.2ms  max=1.35s   p(90)=1.08s p(95)=1.15s</code></pre></div>\n<p>어차피 DB의 한계 때문에 <code class=\"language-text\">input</code> 을 마냥 많이 받는게 답은 아닌것 같다.</p>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>(1) 에서는 로컬 시스템 만으로 쿠폰 도메인 로직과 동시성 이슈에 대해서 알아보았고,<br>\n(2) 에서는 웹 서버로 올려서 부하테스트를 해보았다. 이벤트 기반으로 DB save 로직을 분리해보았다.<br>\n(3) 다중 서버일때의 환경을 고려해서 Redis 를 적용해보고 테스트 까지 진행해보았다.</p>\n<hr>\n<blockquote>\n<p>여러가지 시나리오를 생각하며 진행해본 작업이었는데 재미있었다.</p>\n</blockquote>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%A0%88%EB%94%94%EC%8A%A4%EB%A5%BC-%EC%A0%81%EC%9A%A9%ED%95%B4%EB%B3%B4%EC%9E%90\">레디스를 적용해보자</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\">시나리오</a></p>\n<ul>\n<li><a href=\"#%EA%B5%AC%ED%98%84\">구현</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8\">부하 테스트</a></p>\n</li>\n<li>\n<p><a href=\"#db-pool-size-%EC%A1%B0%EC%A0%95%ED%95%B4%EB%B3%B4%EB%A9%B4-%EC%96%B4%EB%96%A8%EA%B9%8C\">DB POOL SIZE 조정해보면 어떨까?</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></p>\n</li>\n</ul>\n</div>","excerpt":"레디스를 적용해보자 시나리오 1. Coupon 이 생성 될때, 발행갯수만큼 CouponTicket(userId가 null 상태)을 DB에 저장한다. 2. 쿠폰 발급, CouponTicket의 ID를 Redis에 쌓는다. 3. 쿠폰 배급 Redis에 쌓이 CouponTicket을 가져온다. 가져온 CouponTicket이 이미 userId가 정해져있는지 DB에 확인하고 정해져 있지 않다면 userId를 맵핑하고 저장한다. 쿠폰티켓 결과를 반환해준다. 구현 1. Coupon 이 생성 될때, 발행갯수만큼 CouponTicket(userId가 null 상태)을 DB에 저장한다. 2. 쿠폰 발급, CouponTicket의 ID를 Redis에 쌓는다. 여러 방법이 있겠지만, 스케쥴러를 적용해보기로 했다. 일정 갯수 이하일때 Redis에 쌓기. Redis 설정하기 스케쥴러 적용 1초에 한번씩 체크 2000개 이하일때 10000개씩 밀어 넣게 구현 3. 쿠폰 배급 Redis에 쌓이 CouponT…","frontmatter":{"date":"May 23, 2023","title":"쿠폰 발급 (3) - 레디스 적용","categories":"시리즈","author":"wooobo","emoji":"3️⃣"},"fields":{"slug":"/series/coupon/coupon3/"}},"next":{"id":"9c6e319a-eaf2-5665-9e01-8732269ad00e","html":"<h2 id=\"새로운-요구사항\" style=\"position:relative;\"><a href=\"#%EC%83%88%EB%A1%9C%EC%9A%B4-%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD\" aria-label=\"새로운 요구사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>새로운 요구사항</h2>\n<blockquote>\n<p>팀장: 잘 구현 해주셨군요. 대략적인 쿠폰 발행에 대해 이해도가 높아진것 같네요. 서버로 이제 구현해주세요.</p>\n</blockquote>\n<h2 id=\"세팅하기\" style=\"position:relative;\"><a href=\"#%EC%84%B8%ED%8C%85%ED%95%98%EA%B8%B0\" aria-label=\"세팅하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>세팅하기</h2>\n<div class=\"gatsby-highlight\" data-language=\"gradle\"><pre class=\"language-gradle\"><code class=\"language-gradle\"># build<span class=\"token punctuation\">.</span>gradle\n<span class=\"token punctuation\">...</span>\n\n<span class=\"token keyword\">dependencies</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">implementation</span> <span class=\"token string\">'org.springframework.boot:spring-boot-starter'</span>\n    <span class=\"token keyword\">implementation</span> <span class=\"token string\">'org.springframework.boot:spring-boot-starter-data-jpa'</span>\n    <span class=\"token keyword\">implementation</span> <span class=\"token string\">'org.springframework.boot:spring-boot-starter-web'</span>\n    <span class=\"token keyword\">implementation</span> <span class=\"token string\">'com.google.guava:guava:30.1-jre'</span>\n\n    <span class=\"token keyword\">implementation</span> <span class=\"token string\">'com.mysql:mysql-connector-j'</span>\n\n    testImplementation <span class=\"token string\">'com.h2database:h2'</span>\n    testImplementation <span class=\"token string\">'org.springframework.boot:spring-boot-starter-test'</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">...</span>\n\n<span class=\"token operator\">--</span><span class=\"token operator\">-</span>\n\n# Application\n\n<span class=\"token annotation punctuation\">@SpringBootApplication</span>\npublic class <span class=\"token class-name\">DemoApplication</span> <span class=\"token punctuation\">{</span>\n\n    public static void <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        SpringApplication<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>DemoApplication<span class=\"token punctuation\">.</span>class<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"발급-서비스\" style=\"position:relative;\"><a href=\"#%EB%B0%9C%EA%B8%89-%EC%84%9C%EB%B9%84%EC%8A%A4\" aria-label=\"발급 서비스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>발급 서비스</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponTicketDistribution</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">COUNT</span> <span class=\"token operator\">=</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LinkedBlockingQueue</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> tickets<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponTicketDistribution</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tickets <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponRepository <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">CouponTicket</span> <span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">LinkedBlockingQueue</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> queue <span class=\"token operator\">=</span> <span class=\"token function\">getCouponTickets</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> couponTickets <span class=\"token operator\">=</span> <span class=\"token function\">getTickets</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                couponTickets<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>queue<span class=\"token operator\">::</span><span class=\"token function\">offer</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IllegalArgumentException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getTickets</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Coupon</span> coupon <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> couponTickets <span class=\"token operator\">=</span> coupon<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token constant\">COUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAndFlush</span><span class=\"token punctuation\">(</span>coupon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> couponTickets<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LinkedBlockingQueue</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getCouponTickets</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">LinkedBlockingQueue</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> queue <span class=\"token operator\">=</span> tickets<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>queue <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            queue <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedBlockingQueue</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            tickets<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">,</span> queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> queue<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"동시-요청-테스트\" style=\"position:relative;\"><a href=\"#%EB%8F%99%EC%8B%9C-%EC%9A%94%EC%B2%AD-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"동시 요청 테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>동시 요청 테스트</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token annotation punctuation\">@ActiveProfiles</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponTicketDistributionTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token class-name\">CouponTicketDistribution</span> couponTicketDistribution<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">traffic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">LIMIT</span> <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Coupon</span> coupon <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Coupon</span><span class=\"token punctuation\">.</span><span class=\"token function\">limitOf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LIMIT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">int</span> numberOfThreads <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">LIMIT</span> <span class=\"token operator\">*</span> <span class=\"token number\">1.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ExecutorService</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span>numberOfThreads<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">CountDownLatch</span> latch <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span>numberOfThreads<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">AtomicInteger</span> activeCount <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicInteger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">AtomicInteger</span> errorCount <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicInteger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> times <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> numberOfThreads<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> finalI <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n            executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">long</span> startTime <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">long</span> stackTime <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n                    <span class=\"token class-name\">CouponTicket</span> actual <span class=\"token operator\">=</span> couponTicketDistribution<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span>coupon<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>actual <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        errorCount<span class=\"token punctuation\">.</span><span class=\"token function\">getAndIncrement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                        activeCount<span class=\"token punctuation\">.</span><span class=\"token function\">getAndIncrement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n\n                    times<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">timeLog</span><span class=\"token punctuation\">(</span>finalI<span class=\"token punctuation\">,</span> startTime<span class=\"token punctuation\">,</span> stackTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"발급불가 : \"</span> <span class=\"token operator\">+</span> finalI <span class=\"token operator\">+</span> <span class=\"token string\">\" / \"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                latch<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        latch<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">assertAll</span><span class=\"token punctuation\">(</span>\n                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>activeCount<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token constant\">LIMIT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>errorCount<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>numberOfThreads <span class=\"token operator\">-</span> <span class=\"token constant\">LIMIT</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 249px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/klEQVQ4y3WTWU/bUBSE+TeUOImX2I4T7/ESJ3EWArRAQ2mFqJBa9f+/TTXDIlDMg3UXn3vON2fuPTkbJOiZGQwzQ2+YwjBz9K2Z5meDFAO7eNvvDbN3c/5P8KUfa3z9ToZOiXLxC2F6BXNUYxydo1n/Rph9hTfdYHPxD0F0jrz+obUbrFE096iWD7C8BqdG+DEhK5mjSlW5QSLTnYuSe7a30HzoVG97w1GlNc92EhbNT8SzG5huDT/coW4fMU2v4E02aPd/MY52yKoDvMkabtCKlqosd/4ZYa2q7NHALiWFpIaVwxkvRcaYV0IW5prxR4QDp8Rsfo8o/6Ygf7pFtXp4IVxjtfuDcbhDWn4X3ShYIavuUDSfEmb60bee3WRvHH8pUhIxCWkZw5F7VMB1N6FdqCfT5FKEpGJ/JsmlHF1sn0SdFLcYkXC8Ei1VdROaGWx/IWd5F5mUB+WqXcAPt6BxjOHIPSqwvUbxnYRpeXghrCSR1YN4r8Tz9lFuR/m1DGKypLhBXt8J4tSIPiaka5RhiTBXfyiRpOzjJL5QIZrBkSYyKT/GHxGyybyDJKIkUmTlQS+Gc/aT1HSdsik1nl2rjyzaSUgjGEjXeIjJSMw+6km6c8Xw/nFP5gSt7ukxIXtY3IqQEimf/QmiveZ8s+5krbctM/yFHOdd7CL8DyU811n0UyhFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon 2 01\"\n        title=\"coupon 2 01\"\n        src=\"/static/c9bed6f6b9b387f9037a95745e81cff4/6a5fb/coupon-2-01.png\"\n        srcset=\"/static/c9bed6f6b9b387f9037a95745e81cff4/e9ff0/coupon-2-01.png 180w,\n/static/c9bed6f6b9b387f9037a95745e81cff4/6a5fb/coupon-2-01.png 249w\"\n        sizes=\"(max-width: 249px) 100vw, 249px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>오래걸리는 작업은 <code class=\"language-text\">126ms</code> 까지 나왔다.<br>\n좀 더 빨리 할 수 없을까? 고민이 되었다.</p>\n<p><em>이미 발급이 종료되었다면 빠르게 리턴하면 좋지 않을까?</em></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">CouponTicket</span> <span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isFinal<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">&lt;=</span><span class=\"token operator\">=</span> 빠르게 리턴\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n   <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getTickets</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Coupon</span> coupon <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">updateIsFinal</span><span class=\"token punctuation\">(</span>coupon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> # <span class=\"token operator\">&lt;=</span><span class=\"token operator\">=</span> 추가\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> couponTickets <span class=\"token operator\">=</span> coupon<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token constant\">COUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAndFlush</span><span class=\"token punctuation\">(</span>coupon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> couponTickets<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>테스트 결과 <code class=\"language-text\">58ms</code>로 절반 정도 시간이 단축되었다.</strong></p>\n<h2 id=\"중간점검\" style=\"position:relative;\"><a href=\"#%EC%A4%91%EA%B0%84%EC%A0%90%EA%B2%80\" aria-label=\"중간점검 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>중간점검</h2>\n<ul>\n<li>쿠폰이 발급해야되는 양만큼 정확히 발급 테스트 완료</li>\n<li>100ms 이하 처리 속도 테스트 완료</li>\n</ul>\n<h2 id=\"서버-부하-테스트를-위한-준비\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B2%84-%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8%EB%A5%BC-%EC%9C%84%ED%95%9C-%EC%A4%80%EB%B9%84\" aria-label=\"서버 부하 테스트를 위한 준비 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서버 부하 테스트를 위한 준비</h2>\n<h3 id=\"컨트롤러\" style=\"position:relative;\"><a href=\"#%EC%BB%A8%ED%8A%B8%EB%A1%A4%EB%9F%AC\" aria-label=\"컨트롤러 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>컨트롤러</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponTicketDistribution</span> couponTicketDistribution<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponController</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponTicketDistribution</span> couponTicketDistribution<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponTicketDistribution <span class=\"token operator\">=</span> couponTicketDistribution<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"api/index\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TicketDto</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">CouponTicket</span> couponTicket <span class=\"token operator\">=</span> couponTicketDistribution<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token number\">1L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>couponTicket <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TicketDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>couponTicket<span class=\"token punctuation\">.</span><span class=\"token function\">getCouponId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TicketDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>CouponTicket 또한 발급하고 데이터 베이스에 저장 코드를 추가하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"># <span class=\"token class-name\">CouponTicketDistribution</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">CouponTicket</span> <span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n       <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n        <span class=\"token class-name\">CouponTicket</span> couponTicket <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>couponTicket <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>couponTicket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">&lt;=</span><span class=\"token operator\">=</span> 쿠폰티켓 <span class=\"token constant\">DB</span>저장 \n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<h2 id=\"부하-테스트\" style=\"position:relative;\"><a href=\"#%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"부하 테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>부하 테스트</h2>\n<p>API 부하 테스트를 진행하고자 한다.<br>\n부하 테스트는 응답시간만 간단하게 체크 할 것이기 떄문에, K6 부하 테스트를 활용한다.<br>\n<a href=\"https://k6.io/\">k6.io</a></p>\n<h3 id=\"k6-테스트-스크립트\" style=\"position:relative;\"><a href=\"#k6-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\" aria-label=\"k6 테스트 스크립트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>K6 테스트 스크립트</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"># script<span class=\"token punctuation\">.</span>js\n<span class=\"token keyword\">import</span> http <span class=\"token keyword\">from</span> <span class=\"token string\">'k6/http'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>check<span class=\"token punctuation\">,</span> sleep<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'k6'</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">stages</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">duration</span><span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">target</span><span class=\"token operator\">:</span> <span class=\"token number\">500</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">duration</span><span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">target</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">duration</span><span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">target</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">duration</span><span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">target</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">thresholds</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">http_req_duration</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'p(99)&lt;100'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://localhost:8080/api/index'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">check</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string-property property\">'status was 200'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token number\">200</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">check</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string-property property\">'error'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>error <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>높은 트래픽에서의 속도만 측정할것이기 때문에 시간은 길게하지 않았다.</em></p>\n<p><img src=\"coupon-2-02.png\" alt=\"\"></p>\n<p><strong>응답시간이 만족스럽지 않다.</strong></p>\n<p><em>어디에서 지연이 되는걸까?</em></p>\n<p>아무래도 “CouponTicket”을 DB에 저장하는 비용이 가장 커보인다.</p>\n<blockquote>\n<p>couponTicketRepository.save(couponTicket); &#x3C;== 쿠폰티켓 DB저장<br>\n제거하고 다시 테스트 해본다.</p>\n</blockquote>\n<p><strong>결과</strong></p>\n<blockquote>\n<p>avg=4.5ms min=80µs med=1.11ms max=121.67ms p(90)=12.68ms p(95)=18.76ms</p>\n</blockquote>\n<p>응답이 빨라졌다. 예상대로 DB저장할때 부하가 많이 발생하는것으로 확인했다.</p>\n<h3 id=\"부하로직을-비동기-처리로\" style=\"position:relative;\"><a href=\"#%EB%B6%80%ED%95%98%EB%A1%9C%EC%A7%81%EC%9D%84-%EB%B9%84%EB%8F%99%EA%B8%B0-%EC%B2%98%EB%A6%AC%EB%A1%9C\" aria-label=\"부하로직을 비동기 처리로 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>부하로직을 비동기 처리로</h3>\n<p>굳이 DB 저장까지 동기적으로 처리 할 필요가 있을까?<br>\n부하가 걸리는 작업은 비동기로 분리하면 어떨까?</p>\n<p><strong>As-IS</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.111111111111107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA2UlEQVQY03VQ0WqEMBDM1/oF/off4R8Igq+Bs/QotpSzpbaC1zQxoojJ6alTsmDxSjuwyzA7OwnLAKBpGkzThD3WdcX5/Amtmxt9nmeq/8Dc0PM8ZFlGglI17OWCYRggpYIQXzDGEneIoghhGBJvuw5t29FngiBAXddgrvm+D845mdK7ewpxplP+iqL4gDEGnB9wvc5I0xRJkpD3rXjH49Mz8TiO0fc92LIsEELQ0h7WWhyPD8jzlxtdKQUpJZ1kD601xnEE2+61GdwDW2BZlqiq6mf+O+Qv/RvgSHr45w4+eQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon 2 03\"\n        title=\"coupon 2 03\"\n        src=\"/static/ae4f764ffe96045e5afaa1045b011e2c/37523/coupon-2-03.png\"\n        srcset=\"/static/ae4f764ffe96045e5afaa1045b011e2c/e9ff0/coupon-2-03.png 180w,\n/static/ae4f764ffe96045e5afaa1045b011e2c/f21e7/coupon-2-03.png 360w,\n/static/ae4f764ffe96045e5afaa1045b011e2c/37523/coupon-2-03.png 720w,\n/static/ae4f764ffe96045e5afaa1045b011e2c/5caea/coupon-2-03.png 996w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><strong>To-Be</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1klEQVQY022QUU+DMBSF+6/5V+5JY3z1TYHExeB40Lk5BnSk3YBJIcBnug1CDCe56W3T7/TcCibq+/5S/88GtYAuCqKvT54f7tnuduR5gVIa3/fxPA9hAdd1qet6BO2lfZzQtu1tn/O9XrMPV6TvS6o3n4+nR7ZxTG0MZVkipSRJEkRVVTiOg5QpaSqRhwPH44nN5get9cU4CALuFgv4PcO5ZE7DdKJpGsIwxBiD7W2qKIp4eb2mtmUTZFl2BW9w13WjyfRbxNxr1kApNY48BQd4brUJ/wBlJ38KACG0ZQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon 2 04\"\n        title=\"coupon 2 04\"\n        src=\"/static/a83265200dc2b80af4329f404d78cbeb/37523/coupon-2-04.png\"\n        srcset=\"/static/a83265200dc2b80af4329f404d78cbeb/e9ff0/coupon-2-04.png 180w,\n/static/a83265200dc2b80af4329f404d78cbeb/f21e7/coupon-2-04.png 360w,\n/static/a83265200dc2b80af4329f404d78cbeb/37523/coupon-2-04.png 720w,\n/static/a83265200dc2b80af4329f404d78cbeb/302a4/coupon-2-04.png 1080w,\n/static/a83265200dc2b80af4329f404d78cbeb/21b4d/coupon-2-04.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<ul>\n<li>이벤트</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RegisteredCouponTicketEvent</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponTicket</span> couponTicket<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">RegisteredCouponTicketEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponTicket</span> couponTicket<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponTicket <span class=\"token operator\">=</span> couponTicket<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponTicket</span> <span class=\"token function\">getTicket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> couponTicket<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>핸들러</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponTicketHandler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponTicketHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponTicketRepository <span class=\"token operator\">=</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Async</span>\n    <span class=\"token annotation punctuation\">@EventListener</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RegisteredCouponTicketEvent</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">getTicket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>CouponTicketDistribution 수정</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponTicketDistribution</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ApplicationEventPublisher</span> applicationEventPublisher<span class=\"token punctuation\">;</span> <span class=\"token operator\">&lt;=</span><span class=\"token operator\">=</span> 추가\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">CouponTicket</span> <span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n     <span class=\"token class-name\">CouponTicket</span> couponTicket <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     applicationEventPublisher<span class=\"token punctuation\">.</span><span class=\"token function\">publishEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">RegisteredCouponTicketEvent</span><span class=\"token punctuation\">(</span>couponTicket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token keyword\">return</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다시 테스트 진행</p>\n<p><strong>결과</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfElEQVQI1yXMWw6DIBRAQTfUR9oUEFC4CKhoTZPufy2nif2Y3+mSqiRd8feAvQ30F8f4EGTYiWYm2fbnNpLfELOQ5EPq15OMbyazEF2j+Ea3DAfFNuIrE54Je/VMbqPkL0EXoq6IXcnhQFwjqIKMO6IrUZUzElUIpiL9zA/mikX8oHYGUAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon 2 05\"\n        title=\"coupon 2 05\"\n        src=\"/static/6abcf615c7c89ba797745f140df428a3/37523/coupon-2-05.png\"\n        srcset=\"/static/6abcf615c7c89ba797745f140df428a3/e9ff0/coupon-2-05.png 180w,\n/static/6abcf615c7c89ba797745f140df428a3/f21e7/coupon-2-05.png 360w,\n/static/6abcf615c7c89ba797745f140df428a3/37523/coupon-2-05.png 720w,\n/static/6abcf615c7c89ba797745f140df428a3/a1792/coupon-2-05.png 780w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>비동기로 처리하여 속도가 향상되었다. 하지만 문제점들이 보였다.</p>\n<h2 id=\"현재-문제점\" style=\"position:relative;\"><a href=\"#%ED%98%84%EC%9E%AC-%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"현재 문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>현재 문제점</h2>\n<p>⚡️로컬 캐쉬 이슈⚡️</p>\n<p><strong>1. 서버가 다운되면 로컬캐쉬가 모두 증발하기 때문에 데이터 불일치가 발생한다.</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVQoz22STW+CQBCG+f8HE03a3+BRTXrwqvQg9aY91GoIxAhqamX52F12l7eZFZCQTrKw7AzPzrwzTlVVKMsSUkporUFmjAGdN9bu67cMviC/N4/Y+p8mzuGcI89zZFmGNE0trIGOx2NEUWS/lVLIshRcVfjdviPZuC3oeDxiuVzavUOZJUmC8/lsDyjb3W4H3/cxHA4RBIE953kOujw8nXBL0vaSOI6xWCwwGo0eQMrkcDhgMplgOp3C8zwLpODr9WohlTEQnINLCXO54PPDg7dew1utsN/vcb/fEYbhA0gP13UxGAwskACNkQxKa6uTKAoUUkK8zTB/fcFsPm/jqCqCthpSebTIQRn3m6KVQikEfm43+NstoiCAqf3dptgMCSiEsDBqSrdj3UUTwBgDyzIkjCEvimdsZxIc2lBjCEq6kRbUpC60MfKXUqJUCrrIoeMIOjrBpOw5NugZadHo2MD64JoOw5iFVUI8gf3S+sPch/4L75T8B7WX/7k/ArVLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon 2 06\"\n        title=\"coupon 2 06\"\n        src=\"/static/94c414c7a996757821ed32c60ef7f79a/37523/coupon-2-06.png\"\n        srcset=\"/static/94c414c7a996757821ed32c60ef7f79a/e9ff0/coupon-2-06.png 180w,\n/static/94c414c7a996757821ed32c60ef7f79a/f21e7/coupon-2-06.png 360w,\n/static/94c414c7a996757821ed32c60ef7f79a/37523/coupon-2-06.png 720w,\n/static/94c414c7a996757821ed32c60ef7f79a/302a4/coupon-2-06.png 1080w,\n/static/94c414c7a996757821ed32c60ef7f79a/21b4d/coupon-2-06.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><strong>2. 안정된 서비스 운영을 위해 서버 이중화가 필요한데, 현재 구조로는 서버 하나일 경우만 데이터 무결성,정합성이 유지된다.</strong></p>\n<ul>\n<li>현재 구조에서 서버를 늘릴경우</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 524px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 115.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAAClElEQVQ4y51VOWtqQRj1N2nvLxCxTGmTwsZGCQHBSglWgqVICIhImkAsUqhViLFwyVK4QdxRE02i4h7jCWfCXK7LS8wbmHvnznLmfOd8M1eDPcpqtfrxrW5r+Hh9fUWv18P7+zva7Tbe3t7EN6t6sazL5RKfn5+in+2Pjw9ljmaxWKDVau1kxP75fC7aBOBidXl+fobT6cTR0RGenp6+GRKw3+9jOByiUCjg9vYW5XJZsGXfZDJZAxoMBohEIuh0Omg2m7DZbLBarbi7u1sHZJjpdBqJRAKlUkksYCjBYFC0K5UK/H4/3G43Li4uICPT6/XQ6XTrgFywq3CSwWBAIBCAz+dDKpVaGyf76+trxGIxTKfTb0CyYHhSYLKVIudyOZhMJrhcri19z87OEI1Gt7TXUHQ6y3J+fg6z2YzT01PxLTciM7IJh8MoFovwer0IhUKYzWZCc7ar1eo2QwIdHh6KEMm0Xq8L4RkO53Hs4OBACZ3Od7tdNBoNsaGioWTocDhgt9uV8Fk4TjBG4vF4cHx8jKurK0WWrZA5wMTmbnTt/v5eDNRqNeH2y8uLSPDxeLyWOuqE51rlpJAJXWa6sGYyGcU95hs3yOfzAnQzG9RHTxYRMllQM+pF3TZPBL85j8zUx3AX6JopLExwKbAamI5y438xUwAZP12Sl4O0n+lBg05OTjAajQQ4N/sVUDKhiwSXjieTSVgsFnHwyUymyK+Am4O8QSSgVquF0WgU7LnpXiFvikxzqBffl5eXiMfjol+t9Z8AyeLx8RHZbFakzMPDA25ubgTYXiFvAvIOJCjvRALTJF6edJ5jfwakhpt5KI+g1PdPgOr/ChOZbNnH4/lfGjI9GB5vGKYS2zSJVf6YfgL8AvMCvGJA9JSOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon 2 07\"\n        title=\"coupon 2 07\"\n        src=\"/static/3b63cd3403cbc0b87014fe9d79a3aeb0/664c8/coupon-2-07.png\"\n        srcset=\"/static/3b63cd3403cbc0b87014fe9d79a3aeb0/e9ff0/coupon-2-07.png 180w,\n/static/3b63cd3403cbc0b87014fe9d79a3aeb0/f21e7/coupon-2-07.png 360w,\n/static/3b63cd3403cbc0b87014fe9d79a3aeb0/664c8/coupon-2-07.png 524w\"\n        sizes=\"(max-width: 524px) 100vw, 524px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>쿠폰티켓은 발행 제한을 시켜야한다.<br>\n서버만 증설한다면 각자 캐쉬를 가지고 있기 때문에 정합성을 지킬 수 없다.<br>\n서버간의 존재를 중재해줄수 있는 역할이 필요하거나 <strong>글로벌 캐쉬 서버</strong>가 필요 할 것 같다.</p>\n<p><strong>3. CouponTicket 생성 이벤트가 실패한다면?</strong></p>\n<ul>\n<li>후속 처리가 필요하다. 유저는 이미 발급 성공을 받았는데 쿠폰 티켓이 존재하지 않는다면 서비스의 신뢰도가 하락 될 것이다.</li>\n</ul>\n<h3 id=\"단순화-하자\" style=\"position:relative;\"><a href=\"#%EB%8B%A8%EC%88%9C%ED%99%94-%ED%95%98%EC%9E%90\" aria-label=\"단순화 하자 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>단순화 하자</h3>\n<ol>\n<li>쿠폰 발행 입장\n<ul>\n<li>쿠폰을 발행만 한다.</li>\n</ul>\n</li>\n<li>쿠폰전달 입장\n<ul>\n<li>쿠폰이 있으면 전달만한다.</li>\n</ul>\n</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABBUlEQVQoz31S2W6EMAzM//8Lb4hXvoEHKKrKqgi2LPd9LjDVRGKVpagjRUkcezy2I7quQ1VVWJYFxL7vf/azTbWra11XiCzLEIYhSHw4Pp/LJQHBxAycpgllWUoxKgQNaZqiKIpXgG3biB4PeQ+CALquy3OSJLAsC3VdS0LGDsOAnyhCnCQwTROCWdq2lYR0GscRX94NrvuJbVvhOA4Mw5CEzocLz7thHCdJRFDtt+8jDO/QNA2CWVkuiQ+nA3yjQibzff/tre/7txYQVC7yPMc8zy+no8HbtuEM1U4RbBVnQNKjx6JpGlmqSvjfJNWJU4j6O7gE5bK0OI5B8qsvc0V2Vn7svzS6bD1eiBdPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coupon 2 08\"\n        title=\"coupon 2 08\"\n        src=\"/static/53fbd366ad0e906d67cb7e12c41f5b86/37523/coupon-2-08.png\"\n        srcset=\"/static/53fbd366ad0e906d67cb7e12c41f5b86/e9ff0/coupon-2-08.png 180w,\n/static/53fbd366ad0e906d67cb7e12c41f5b86/f21e7/coupon-2-08.png 360w,\n/static/53fbd366ad0e906d67cb7e12c41f5b86/37523/coupon-2-08.png 720w,\n/static/53fbd366ad0e906d67cb7e12c41f5b86/302a4/coupon-2-08.png 1080w,\n/static/53fbd366ad0e906d67cb7e12c41f5b86/21b4d/coupon-2-08.png 1280w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h3 id=\"설명\" style=\"position:relative;\"><a href=\"#%EC%84%A4%EB%AA%85\" aria-label=\"설명 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>설명</h3>\n<ol>\n<li>서버의 입장에서는 쿠폰이 있으면 Queue 저장소에서 빼서 전달만하면 된다.</li>\n<li>발급 서버는 쿠폰을 발급 하기만 하면 된다.</li>\n</ol>\n<h2 id=\"다음-포스팅에서는\" style=\"position:relative;\"><a href=\"#%EB%8B%A4%EC%9D%8C-%ED%8F%AC%EC%8A%A4%ED%8C%85%EC%97%90%EC%84%9C%EB%8A%94\" aria-label=\"다음 포스팅에서는 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>다음 포스팅에서는…</h2>\n<p>글로벌 캐쉬로 레디스를 사용해봐야겠다.</p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EC%83%88%EB%A1%9C%EC%9A%B4-%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD\">새로운 요구사항</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%84%B8%ED%8C%85%ED%95%98%EA%B8%B0\">세팅하기</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%B0%9C%EA%B8%89-%EC%84%9C%EB%B9%84%EC%8A%A4\">발급 서비스</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%8F%99%EC%8B%9C-%EC%9A%94%EC%B2%AD-%ED%85%8C%EC%8A%A4%ED%8A%B8\">동시 요청 테스트</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%A4%91%EA%B0%84%EC%A0%90%EA%B2%80\">중간점검</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%84%9C%EB%B2%84-%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8%EB%A5%BC-%EC%9C%84%ED%95%9C-%EC%A4%80%EB%B9%84\">서버 부하 테스트를 위한 준비</a></p>\n<ul>\n<li><a href=\"#%EC%BB%A8%ED%8A%B8%EB%A1%A4%EB%9F%AC\">컨트롤러</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8\">부하 테스트</a></p>\n<ul>\n<li><a href=\"#k6-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\">K6 테스트 스크립트</a></li>\n<li><a href=\"#%EB%B6%80%ED%95%98%EB%A1%9C%EC%A7%81%EC%9D%84-%EB%B9%84%EB%8F%99%EA%B8%B0-%EC%B2%98%EB%A6%AC%EB%A1%9C\">부하로직을 비동기 처리로</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%98%84%EC%9E%AC-%EB%AC%B8%EC%A0%9C%EC%A0%90\">현재 문제점</a></p>\n<ul>\n<li><a href=\"#%EB%8B%A8%EC%88%9C%ED%99%94-%ED%95%98%EC%9E%90\">단순화 하자</a></li>\n<li><a href=\"#%EC%84%A4%EB%AA%85\">설명</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%8B%A4%EC%9D%8C-%ED%8F%AC%EC%8A%A4%ED%8C%85%EC%97%90%EC%84%9C%EB%8A%94\">다음 포스팅에서는…</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"May 21, 2023","title":"쿠폰 발급 (2) - 부하테스트","categories":"시리즈","author":"wooobo","emoji":"2️⃣"},"fields":{"slug":"/series/coupon/coupon2/"}},"prev":{"id":"11387ee9-349e-5c1e-857e-5e6a16089a0b","html":"<h1 id=\"개요\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개요???</h1>\n<p>최근에 프로젝트를 진행하면서, 리눅스 커널단의 설정에 의해 이슈가 발생하였다.<br>\n그래서 이번 기회에 TCP_TW 설정에 대해 알아보고자 한다.</p>\n<p>이전에 이슈가 된 설정은 <code class=\"language-text\">tcp_tw_reuse</code>, <code class=\"language-text\">tcp_tw_recycle</code> 옵션이었는데, 이 옵션들은 <code class=\"language-text\">TIME_WAIT</code> 상태의 소켓을 재사용하는 옵션이다.</p>\n<h1 id=\"time_wait\" style=\"position:relative;\"><a href=\"#time_wait\" aria-label=\"time_wait permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TIME_WAIT?</h1>\n<p>TIME_WAIT 상태는 TCP 연결이 종료된 후, 일정 시간 동안 유지되는 상태이다.</p>\n<h1 id=\"이슈\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EC%8A%88\" aria-label=\"이슈 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이슈</h1>\n<p>최근 azure 의 <code class=\"language-text\">AKS</code>를 세팅하면서 외부 요청에 대한 타임아웃이 발생하는 이슈가 있었다.</p>\n<h2 id=\"환경\" style=\"position:relative;\"><a href=\"#%ED%99%98%EA%B2%BD\" aria-label=\"환경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>환경</h2>\n<ul>\n<li>AKS에 하나의 파드에 두개의 컨테이너를 띄운 상태</li>\n<li>NAT 게이트웨이를 사용</li>\n</ul>\n<h2 id=\"이슈-시나리오\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EC%8A%88-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"이슈 시나리오 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이슈 시나리오</h2>\n<ol>\n<li>A컨테이너에서만 외부API를 호출하면 바로바로 응답이 옴</li>\n<li>B컨테이너에서만 외부API를 호출하면 바로바로 응답이 옴</li>\n<li>A컨테이너에서 외부API호출 후 바로 B컨테이너에서  외부API를 호출하면 타임아웃이 발생함</li>\n</ol>\n<p>AKS초기 구성시에는 해당 현상이 발생하지 않았었다.\n그런데, 어느 순간 해당 현상이 발생하기 시작했다.</p>\n<p>서버 구축을 해주던 인프라팀에서 “tcp_tw_reuse, tcp_tw_recycle” 에 대한 세팅 이슈때문에 발생한것이라고 했다.</p>\n<p><a href=\"https://brunch.co.kr/@alden/3\">참고 블로그</a> 해당 블로그 내용에서 NAT 를 사용할때 <code class=\"language-text\">tcp_tw_recycle</code> 을 활성화한 서버에 접속할경우 해당 이슈가 발생한다고 했다.<br>\n그렇다, AKS 초기 세팅에서는 발생하지 않았지만 NAT를 연결한 순간 발생한것으로 추측이된다.</p>\n<h1 id=\"재현해보자\" style=\"position:relative;\"><a href=\"#%EC%9E%AC%ED%98%84%ED%95%B4%EB%B3%B4%EC%9E%90\" aria-label=\"재현해보자 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>재현해보자</h1>\n<h2 id=\"client--server-띄우기\" style=\"position:relative;\"><a href=\"#client--server-%EB%9D%84%EC%9A%B0%EA%B8%B0\" aria-label=\"client  server 띄우기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Client / Server 띄우기</h2>\n<ul>\n<li>도커로 Client 와 Server 를 구축해보자</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">\n<span class=\"token comment\"># 네트워크 생성</span>\n<span class=\"token function\">docker</span> network create tw-net\n\n<span class=\"token comment\"># 서버</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> server_test <span class=\"token parameter variable\">--net</span> tw-net <span class=\"token parameter variable\">-p</span> <span class=\"token number\">91</span>:80 <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--privileged</span> ubuntu:20.04\n<span class=\"token function\">apt</span> update\n<span class=\"token function\">apt</span> <span class=\"token function\">install</span> nginx\n<span class=\"token function\">service</span> nginx start\n\n<span class=\"token comment\"># 클라이언트</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> client_test <span class=\"token parameter variable\">--net</span> tw-net <span class=\"token parameter variable\">-p</span> <span class=\"token number\">92</span>:80 <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--privileged</span> ubuntu:20.04\n\n<span class=\"token comment\"># 필요한 라이브러리 설치</span>\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> net-tools\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token function\">vim</span>\n</code></pre></div>\n<h2 id=\"client-에서-tcp_tw_reuse-활성화하기\" style=\"position:relative;\"><a href=\"#client-%EC%97%90%EC%84%9C-tcp_tw_reuse-%ED%99%9C%EC%84%B1%ED%99%94%ED%95%98%EA%B8%B0\" aria-label=\"client 에서 tcp_tw_reuse 활성화하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Client 에서 tcp_tw_reuse 활성화하기</h2>\n<ol>\n<li>Client -> Server 호출해보기</li>\n</ol>\n<ul>\n<li>Docker 네트워크 상에서 Server IP를 확인하자.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">docker</span> network inspect tw-net\n<span class=\"token punctuation\">..</span>.\n\n<span class=\"token string\">\"Containers\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"4e879dc9a3e1ced91553d6464d98361ab639bb229d21780234f254c9ab2e8763\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"client_test\"</span>,\n        <span class=\"token string\">\"EndpointID\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"aff17140447ea02482cf5dd79ee032bfc26ce5d4bfbd643396b71a354a3e2008\"</span>,\n        <span class=\"token string\">\"MacAddress\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"02:42:ac:14:00:03\"</span>,\n        <span class=\"token string\">\"IPv4Address\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"172.20.0.3/16\"</span>,\n        <span class=\"token string\">\"IPv6Address\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"911846c368f7419762ce537c1e002b5626b2f7a3953eec0addc945fac9914a6a\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"server_test\"</span>,\n        <span class=\"token string\">\"EndpointID\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"b0f83e1544bd7d1d7db17759324ea4b7018913c977e15f6b7fcd734bc1f54a41\"</span>,\n        <span class=\"token string\">\"MacAddress\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"02:42:ac:14:00:02\"</span>,\n        <span class=\"token string\">\"IPv4Address\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"172.20.0.2/16\"</span>, <span class=\"token operator\">&lt;=</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span> Server IP\n        <span class=\"token string\">\"IPv6Address\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>,\n<span class=\"token punctuation\">..</span>.</code></pre></div>\n<ol start=\"2\">\n<li>호출 해보자</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@4e879dc9a3e1:/<span class=\"token comment\"># curl 172.20.0.2</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>Welcome to nginx<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>style<span class=\"token operator\">></span>\n    body <span class=\"token punctuation\">{</span>\n        width: 35em<span class=\"token punctuation\">;</span>\n        margin: <span class=\"token number\">0</span> auto<span class=\"token punctuation\">;</span>\n        font-family: Tahoma, Verdana, Arial, sans-serif<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token operator\">&lt;</span>/style<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span>Welcome to nginx<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span>\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.<span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>For online documentation and support please refer to\n<span class=\"token operator\">&lt;</span>a <span class=\"token assign-left variable\">href</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://nginx.org/\"</span><span class=\"token operator\">></span>nginx.org<span class=\"token operator\">&lt;</span>/a<span class=\"token operator\">></span>.<span class=\"token operator\">&lt;</span>br/<span class=\"token operator\">></span>\nCommercial support is available at\n<span class=\"token operator\">&lt;</span>a <span class=\"token assign-left variable\">href</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://nginx.com/\"</span><span class=\"token operator\">></span>nginx.com<span class=\"token operator\">&lt;</span>/a<span class=\"token operator\">></span>.<span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>em<span class=\"token operator\">></span>Thank you <span class=\"token keyword\">for</span> using nginx.<span class=\"token operator\">&lt;</span>/em<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span> </code></pre></div>\n<p>정상적으로 호출되는것을 알 수 있다.</p>\n<ol start=\"3\">\n<li>계속 호출해서 TIME_WAIT를 확인해보자</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 4번 호출후 확인 </span>\nroot@4e879dc9a3e1:/<span class=\"token comment\"># netstat -n -t | grep 'TIME_WAIT'</span>\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:42604        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:42614        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:42640        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:42630        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\n</code></pre></div>\n<p>각각의 다른 포트로 호출되는것을 확인할 수 있다.</p>\n<blockquote>\n<p>그렇다면 포트를 하나로 줄이면 어떻게 될까? (포트를 고갈시켜보자)</p>\n</blockquote>\n<ol start=\"4\">\n<li>포트를 하나로 줄여서 호출해보자</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 설정 파일</span>\n<span class=\"token function\">vim</span> /etc/sysctl.conf\n\n<span class=\"token comment\"># 하단에 추가 </span>\nnet.ipv4.ip_local_port_range <span class=\"token operator\">=</span> <span class=\"token number\">32768</span> <span class=\"token number\">32768</span>\n\n<span class=\"token comment\"># 변경 내용 적용</span>\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-p</span>\n\n<span class=\"token comment\"># 호출하기</span>\nroot@4e879dc9a3e1:/<span class=\"token comment\"># curl 172.20.0.2</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>Welcome to nginx<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span>\n<span class=\"token punctuation\">..</span>.\n\nroot@4e879dc9a3e1:/<span class=\"token comment\"># curl 172.20.0.2</span>\ncurl: <span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span> Couldn<span class=\"token string\">'t connect to server\n \nroot@4e879dc9a3e1:/# netstat -n -t | grep '</span>TIME_WAIT'\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:32768        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\n</code></pre></div>\n<ul>\n<li>두번째 호출에서 <code class=\"language-text\">curl: (7) Couldn't connect to server</code> 발생한다.</li>\n</ul>\n<ol start=\"5\">\n<li>그렇다면, 이때 <code class=\"language-text\">tcp_tw_reuse</code> 를 활성화하면 어떻게 될까?</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">\n<span class=\"token comment\"># 설정 파일</span>\n<span class=\"token function\">vim</span> /etc/sysctl.conf\n\n<span class=\"token comment\"># 하단에 추가</span>\nnet.ipv4.tcp_tw_reuse <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n\n<span class=\"token comment\"># 변경 내용 적용</span>\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-p</span> \n\n<span class=\"token comment\"># 여러번 호출하기</span>\n<span class=\"token function\">curl</span> <span class=\"token number\">172.20</span>.0.2 \n\n- 정상 호출됨</code></pre></div>\n<h2 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<ul>\n<li><code class=\"language-text\">tcp_tw_reuse</code> 를 활성화하면, TIME_WAIT 상태의 포트를 재사용할 수 있다.</li>\n<li>자세한 내용은 <a href=\"https://cyuu.tistory.com/139\">https://cyuu.tistory.com/139</a> 여기를 참고</li>\n</ul>\n<h2 id=\"tcp_tw_recycle\" style=\"position:relative;\"><a href=\"#tcp_tw_recycle\" aria-label=\"tcp_tw_recycle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>tcp_tw_recycle!?</h2>\n<ul>\n<li>tcp_tw_recycle 은 Linux 4.12 on 2017 이후 제거 되었다고 한다 (<a href=\"https://djangocas.dev/blog/troubleshooting-tcp_tw_recycle-no-such-file-or-directory/\">참고</a>)</li>\n<li>docker ubuntu 20.04 에서는 <code class=\"language-text\">tcp_tw_recycle</code> 설정이 없다. 그래서 다른 블로그의 테스트를 참고해보길 바란다.\n<ul>\n<li><a href=\"https://brunch.co.kr/@alden/3\">tcp_tw_reuse와 tcp_tw_recycle</a> 여기 블로그를 보면 자세한 내용을 확인할수있다.</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"회고\" style=\"position:relative;\"><a href=\"#%ED%9A%8C%EA%B3%A0\" aria-label=\"회고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>회고</h1>\n<p>처음에 해당 현상이 발생했을때, azure의 네트워크 이슈인지 알았다.<br>\n나는 어플리케이션 레벨에서 이슈를 찾을려고 했다. 당연히 찾을 수 가 없었다.<br>\n이번의 계기로 다양한 범위에서 이슈를 찾기위한 노력이 필요하다는것을 알게 되었다.</p>\n<h2 id=\"참고\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고</h2>\n<ul>\n<li><a href=\"https://cyuu.tistory.com/139\">https://cyuu.tistory.com/139</a></li>\n<li><a href=\"https://brunch.co.kr/@alden/\">https://brunch.co.kr/@alden/</a></li>\n</ul>","frontmatter":{"date":"July 31, 2023","title":"TCP_TW 옵션?","categories":"프로그래밍","author":"wooobo","emoji":"🔮"},"fields":{"slug":"/network/2023-07-31-tcp-tw/"}},"site":{"siteMetadata":{"siteUrl":"https://wooobo.github.io","comments":{"utterances":{"repo":""}}}}},"pageContext":{"slug":"/series/coupon/coupon3/","nextSlug":"/series/coupon/coupon2/","prevSlug":"/network/2023-07-31-tcp-tw/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}