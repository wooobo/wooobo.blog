{"componentChunkName":"component---src-templates-blog-template-js","path":"/network/2023-07-31-tcp-tw/","result":{"data":{"cur":{"id":"9697e69a-1f6d-56b7-940b-adea11c02f81","html":"<h1 id=\"ê°œìš”\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"ê°œìš” permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ê°œìš”?</h1>\n<p>ìµœê·¼ì— í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ, ë¦¬ëˆ…ìŠ¤ ì»¤ë„ë‹¨ì˜ ì„¤ì •ì— ì˜í•´ ì´ìŠˆê°€ ë°œìƒí•˜ì˜€ë‹¤.<br>\nê·¸ë˜ì„œ ì´ë²ˆ ê¸°íšŒì— TCP_TW ì„¤ì •ì— ëŒ€í•´ ì•Œì•„ë³´ê³ ì í•œë‹¤.</p>\n<p>ì´ì „ì— ì´ìŠˆê°€ ëœ ì„¤ì •ì€ <code class=\"language-text\">tcp_tw_reuse</code>, <code class=\"language-text\">tcp_tw_recycle</code> ì˜µì…˜ì´ì—ˆëŠ”ë°, ì´ ì˜µì…˜ë“¤ì€ <code class=\"language-text\">TIME_WAIT</code> ìƒíƒœì˜ ì†Œì¼“ì„ ì¬ì‚¬ìš©í•˜ëŠ” ì˜µì…˜ì´ë‹¤.</p>\n<h1 id=\"time_wait\" style=\"position:relative;\"><a href=\"#time_wait\" aria-label=\"time_wait permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TIME_WAIT?</h1>\n<p>TIME_WAIT ìƒíƒœëŠ” TCP ì—°ê²°ì´ ì¢…ë£Œëœ í›„, ì¼ì • ì‹œê°„ ë™ì•ˆ ìœ ì§€ë˜ëŠ” ìƒíƒœì´ë‹¤.</p>\n<h1 id=\"ì´ìŠˆ\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EC%8A%88\" aria-label=\"ì´ìŠˆ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ì´ìŠˆ</h1>\n<p>ìµœê·¼ azure ì˜ <code class=\"language-text\">AKS</code>ë¥¼ ì„¸íŒ…í•˜ë©´ì„œ ì™¸ë¶€ ìš”ì²­ì— ëŒ€í•œ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•˜ëŠ” ì´ìŠˆê°€ ìˆì—ˆë‹¤.</p>\n<h2 id=\"í™˜ê²½\" style=\"position:relative;\"><a href=\"#%ED%99%98%EA%B2%BD\" aria-label=\"í™˜ê²½ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>í™˜ê²½</h2>\n<ul>\n<li>AKSì— í•˜ë‚˜ì˜ íŒŒë“œì— ë‘ê°œì˜ ì»¨í…Œì´ë„ˆë¥¼ ë„ìš´ ìƒíƒœ</li>\n<li>NAT ê²Œì´íŠ¸ì›¨ì´ë¥¼ ì‚¬ìš©</li>\n</ul>\n<h2 id=\"ì´ìŠˆ-ì‹œë‚˜ë¦¬ì˜¤\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EC%8A%88-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"ì´ìŠˆ ì‹œë‚˜ë¦¬ì˜¤ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ì´ìŠˆ ì‹œë‚˜ë¦¬ì˜¤</h2>\n<ol>\n<li>Aì»¨í…Œì´ë„ˆì—ì„œë§Œ ì™¸ë¶€APIë¥¼ í˜¸ì¶œí•˜ë©´ ë°”ë¡œë°”ë¡œ ì‘ë‹µì´ ì˜´</li>\n<li>Bì»¨í…Œì´ë„ˆì—ì„œë§Œ ì™¸ë¶€APIë¥¼ í˜¸ì¶œí•˜ë©´ ë°”ë¡œë°”ë¡œ ì‘ë‹µì´ ì˜´</li>\n<li>Aì»¨í…Œì´ë„ˆì—ì„œ ì™¸ë¶€APIí˜¸ì¶œ í›„ ë°”ë¡œ Bì»¨í…Œì´ë„ˆì—ì„œ  ì™¸ë¶€APIë¥¼ í˜¸ì¶œí•˜ë©´ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•¨</li>\n</ol>\n<p>AKSì´ˆê¸° êµ¬ì„±ì‹œì—ëŠ” í•´ë‹¹ í˜„ìƒì´ ë°œìƒí•˜ì§€ ì•Šì•˜ì—ˆë‹¤.\nê·¸ëŸ°ë°, ì–´ëŠ ìˆœê°„ í•´ë‹¹ í˜„ìƒì´ ë°œìƒí•˜ê¸° ì‹œì‘í–ˆë‹¤.</p>\n<p>ì„œë²„ êµ¬ì¶•ì„ í•´ì£¼ë˜ ì¸í”„ë¼íŒ€ì—ì„œ â€œtcp_tw_reuse, tcp_tw_recycleâ€ ì— ëŒ€í•œ ì„¸íŒ… ì´ìŠˆë•Œë¬¸ì— ë°œìƒí•œê²ƒì´ë¼ê³  í–ˆë‹¤.</p>\n<p><a href=\"https://brunch.co.kr/@alden/3\">ì°¸ê³  ë¸”ë¡œê·¸</a> í•´ë‹¹ ë¸”ë¡œê·¸ ë‚´ìš©ì—ì„œ NAT ë¥¼ ì‚¬ìš©í• ë•Œ <code class=\"language-text\">tcp_tw_recycle</code> ì„ í™œì„±í™”í•œ ì„œë²„ì— ì ‘ì†í• ê²½ìš° í•´ë‹¹ ì´ìŠˆê°€ ë°œìƒí•œë‹¤ê³  í–ˆë‹¤.<br>\nê·¸ë ‡ë‹¤, AKS ì´ˆê¸° ì„¸íŒ…ì—ì„œëŠ” ë°œìƒí•˜ì§€ ì•Šì•˜ì§€ë§Œ NATë¥¼ ì—°ê²°í•œ ìˆœê°„ ë°œìƒí•œê²ƒìœ¼ë¡œ ì¶”ì¸¡ì´ëœë‹¤.</p>\n<h1 id=\"ì¬í˜„í•´ë³´ì\" style=\"position:relative;\"><a href=\"#%EC%9E%AC%ED%98%84%ED%95%B4%EB%B3%B4%EC%9E%90\" aria-label=\"ì¬í˜„í•´ë³´ì permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ì¬í˜„í•´ë³´ì</h1>\n<h2 id=\"client--server-ë„ìš°ê¸°\" style=\"position:relative;\"><a href=\"#client--server-%EB%9D%84%EC%9A%B0%EA%B8%B0\" aria-label=\"client  server ë„ìš°ê¸° permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Client / Server ë„ìš°ê¸°</h2>\n<ul>\n<li>ë„ì»¤ë¡œ Client ì™€ Server ë¥¼ êµ¬ì¶•í•´ë³´ì</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">\n<span class=\"token comment\"># ë„¤íŠ¸ì›Œí¬ ìƒì„±</span>\n<span class=\"token function\">docker</span> network create tw-net\n\n<span class=\"token comment\"># ì„œë²„</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> server_test <span class=\"token parameter variable\">--net</span> tw-net <span class=\"token parameter variable\">-p</span> <span class=\"token number\">91</span>:80 <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--privileged</span> ubuntu:20.04\n<span class=\"token function\">apt</span> update\n<span class=\"token function\">apt</span> <span class=\"token function\">install</span> nginx\n<span class=\"token function\">service</span> nginx start\n\n<span class=\"token comment\"># í´ë¼ì´ì–¸íŠ¸</span>\n<span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--name</span> client_test <span class=\"token parameter variable\">--net</span> tw-net <span class=\"token parameter variable\">-p</span> <span class=\"token number\">92</span>:80 <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--privileged</span> ubuntu:20.04\n\n<span class=\"token comment\"># í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜</span>\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> net-tools\n<span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token function\">vim</span>\n</code></pre></div>\n<h2 id=\"client-ì—ì„œ-tcp_tw_reuse-í™œì„±í™”í•˜ê¸°\" style=\"position:relative;\"><a href=\"#client-%EC%97%90%EC%84%9C-tcp_tw_reuse-%ED%99%9C%EC%84%B1%ED%99%94%ED%95%98%EA%B8%B0\" aria-label=\"client ì—ì„œ tcp_tw_reuse í™œì„±í™”í•˜ê¸° permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Client ì—ì„œ tcp_tw_reuse í™œì„±í™”í•˜ê¸°</h2>\n<ol>\n<li>Client -> Server í˜¸ì¶œí•´ë³´ê¸°</li>\n</ol>\n<ul>\n<li>Docker ë„¤íŠ¸ì›Œí¬ ìƒì—ì„œ Server IPë¥¼ í™•ì¸í•˜ì.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">docker</span> network inspect tw-net\n<span class=\"token punctuation\">..</span>.\n\n<span class=\"token string\">\"Containers\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"4e879dc9a3e1ced91553d6464d98361ab639bb229d21780234f254c9ab2e8763\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"client_test\"</span>,\n        <span class=\"token string\">\"EndpointID\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"aff17140447ea02482cf5dd79ee032bfc26ce5d4bfbd643396b71a354a3e2008\"</span>,\n        <span class=\"token string\">\"MacAddress\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"02:42:ac:14:00:03\"</span>,\n        <span class=\"token string\">\"IPv4Address\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"172.20.0.3/16\"</span>,\n        <span class=\"token string\">\"IPv6Address\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"911846c368f7419762ce537c1e002b5626b2f7a3953eec0addc945fac9914a6a\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"Name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"server_test\"</span>,\n        <span class=\"token string\">\"EndpointID\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"b0f83e1544bd7d1d7db17759324ea4b7018913c977e15f6b7fcd734bc1f54a41\"</span>,\n        <span class=\"token string\">\"MacAddress\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"02:42:ac:14:00:02\"</span>,\n        <span class=\"token string\">\"IPv4Address\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"172.20.0.2/16\"</span>, <span class=\"token operator\">&lt;=</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span> Server IP\n        <span class=\"token string\">\"IPv6Address\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>,\n<span class=\"token punctuation\">..</span>.</code></pre></div>\n<ol start=\"2\">\n<li>í˜¸ì¶œ í•´ë³´ì</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">root@4e879dc9a3e1:/<span class=\"token comment\"># curl 172.20.0.2</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>Welcome to nginx<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>style<span class=\"token operator\">></span>\n    body <span class=\"token punctuation\">{</span>\n        width: 35em<span class=\"token punctuation\">;</span>\n        margin: <span class=\"token number\">0</span> auto<span class=\"token punctuation\">;</span>\n        font-family: Tahoma, Verdana, Arial, sans-serif<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token operator\">&lt;</span>/style<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span>Welcome to nginx<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/h<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span>\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.<span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span>For online documentation and support please refer to\n<span class=\"token operator\">&lt;</span>a <span class=\"token assign-left variable\">href</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://nginx.org/\"</span><span class=\"token operator\">></span>nginx.org<span class=\"token operator\">&lt;</span>/a<span class=\"token operator\">></span>.<span class=\"token operator\">&lt;</span>br/<span class=\"token operator\">></span>\nCommercial support is available at\n<span class=\"token operator\">&lt;</span>a <span class=\"token assign-left variable\">href</span><span class=\"token operator\">=</span><span class=\"token string\">\"http://nginx.com/\"</span><span class=\"token operator\">></span>nginx.com<span class=\"token operator\">&lt;</span>/a<span class=\"token operator\">></span>.<span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span>p<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>em<span class=\"token operator\">></span>Thank you <span class=\"token keyword\">for</span> using nginx.<span class=\"token operator\">&lt;</span>/em<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/p<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span> </code></pre></div>\n<p>ì •ìƒì ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ”ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.</p>\n<ol start=\"3\">\n<li>ê³„ì† í˜¸ì¶œí•´ì„œ TIME_WAITë¥¼ í™•ì¸í•´ë³´ì</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 4ë²ˆ í˜¸ì¶œí›„ í™•ì¸ </span>\nroot@4e879dc9a3e1:/<span class=\"token comment\"># netstat -n -t | grep 'TIME_WAIT'</span>\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:42604        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:42614        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:42640        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:42630        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\n</code></pre></div>\n<p>ê°ê°ì˜ ë‹¤ë¥¸ í¬íŠ¸ë¡œ í˜¸ì¶œë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>\n<blockquote>\n<p>ê·¸ë ‡ë‹¤ë©´ í¬íŠ¸ë¥¼ í•˜ë‚˜ë¡œ ì¤„ì´ë©´ ì–´ë–»ê²Œ ë ê¹Œ? (í¬íŠ¸ë¥¼ ê³ ê°ˆì‹œì¼œë³´ì)</p>\n</blockquote>\n<ol start=\"4\">\n<li>í¬íŠ¸ë¥¼ í•˜ë‚˜ë¡œ ì¤„ì—¬ì„œ í˜¸ì¶œí•´ë³´ì</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># ì„¤ì • íŒŒì¼</span>\n<span class=\"token function\">vim</span> /etc/sysctl.conf\n\n<span class=\"token comment\"># í•˜ë‹¨ì— ì¶”ê°€ </span>\nnet.ipv4.ip_local_port_range <span class=\"token operator\">=</span> <span class=\"token number\">32768</span> <span class=\"token number\">32768</span>\n\n<span class=\"token comment\"># ë³€ê²½ ë‚´ìš© ì ìš©</span>\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-p</span>\n\n<span class=\"token comment\"># í˜¸ì¶œí•˜ê¸°</span>\nroot@4e879dc9a3e1:/<span class=\"token comment\"># curl 172.20.0.2</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>Welcome to nginx<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span>\n<span class=\"token punctuation\">..</span>.\n\nroot@4e879dc9a3e1:/<span class=\"token comment\"># curl 172.20.0.2</span>\ncurl: <span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span> Couldn<span class=\"token string\">'t connect to server\n \nroot@4e879dc9a3e1:/# netstat -n -t | grep '</span>TIME_WAIT'\ntcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">172.20</span>.0.3:32768        <span class=\"token number\">172.20</span>.0.2:80           TIME_WAIT\n</code></pre></div>\n<ul>\n<li>ë‘ë²ˆì§¸ í˜¸ì¶œì—ì„œ <code class=\"language-text\">curl: (7) Couldn't connect to server</code> ë°œìƒí•œë‹¤.</li>\n</ul>\n<ol start=\"5\">\n<li>ê·¸ë ‡ë‹¤ë©´, ì´ë•Œ <code class=\"language-text\">tcp_tw_reuse</code> ë¥¼ í™œì„±í™”í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">\n<span class=\"token comment\"># ì„¤ì • íŒŒì¼</span>\n<span class=\"token function\">vim</span> /etc/sysctl.conf\n\n<span class=\"token comment\"># í•˜ë‹¨ì— ì¶”ê°€</span>\nnet.ipv4.tcp_tw_reuse <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n\n<span class=\"token comment\"># ë³€ê²½ ë‚´ìš© ì ìš©</span>\n<span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-p</span> \n\n<span class=\"token comment\"># ì—¬ëŸ¬ë²ˆ í˜¸ì¶œí•˜ê¸°</span>\n<span class=\"token function\">curl</span> <span class=\"token number\">172.20</span>.0.2 \n\n- ì •ìƒ í˜¸ì¶œë¨</code></pre></div>\n<h2 id=\"ê²°ë¡ \" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"ê²°ë¡  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ê²°ë¡ </h2>\n<ul>\n<li><code class=\"language-text\">tcp_tw_reuse</code> ë¥¼ í™œì„±í™”í•˜ë©´, TIME_WAIT ìƒíƒœì˜ í¬íŠ¸ë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.</li>\n<li>ìì„¸í•œ ë‚´ìš©ì€ <a href=\"https://cyuu.tistory.com/139\">https://cyuu.tistory.com/139</a> ì—¬ê¸°ë¥¼ ì°¸ê³ </li>\n</ul>\n<h2 id=\"tcp_tw_recycle\" style=\"position:relative;\"><a href=\"#tcp_tw_recycle\" aria-label=\"tcp_tw_recycle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>tcp_tw_recycle!?</h2>\n<ul>\n<li>tcp_tw_recycle ì€ Linux 4.12 on 2017 ì´í›„ ì œê±° ë˜ì—ˆë‹¤ê³  í•œë‹¤ (<a href=\"https://djangocas.dev/blog/troubleshooting-tcp_tw_recycle-no-such-file-or-directory/\">ì°¸ê³ </a>)</li>\n<li>docker ubuntu 20.04 ì—ì„œëŠ” <code class=\"language-text\">tcp_tw_recycle</code> ì„¤ì •ì´ ì—†ë‹¤. ê·¸ë˜ì„œ ë‹¤ë¥¸ ë¸”ë¡œê·¸ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•´ë³´ê¸¸ ë°”ë€ë‹¤.\n<ul>\n<li><a href=\"https://brunch.co.kr/@alden/3\">tcp_tw_reuseì™€ tcp_tw_recycle</a> ì—¬ê¸° ë¸”ë¡œê·¸ë¥¼ ë³´ë©´ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í• ìˆ˜ìˆë‹¤.</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"íšŒê³ \" style=\"position:relative;\"><a href=\"#%ED%9A%8C%EA%B3%A0\" aria-label=\"íšŒê³  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>íšŒê³ </h1>\n<p>ì²˜ìŒì— í•´ë‹¹ í˜„ìƒì´ ë°œìƒí–ˆì„ë•Œ, azureì˜ ë„¤íŠ¸ì›Œí¬ ì´ìŠˆì¸ì§€ ì•Œì•˜ë‹¤.<br>\në‚˜ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì´ìŠˆë¥¼ ì°¾ì„ë ¤ê³  í–ˆë‹¤. ë‹¹ì—°íˆ ì°¾ì„ ìˆ˜ ê°€ ì—†ì—ˆë‹¤.<br>\nì´ë²ˆì˜ ê³„ê¸°ë¡œ ë‹¤ì–‘í•œ ë²”ìœ„ì—ì„œ ì´ìŠˆë¥¼ ì°¾ê¸°ìœ„í•œ ë…¸ë ¥ì´ í•„ìš”í•˜ë‹¤ëŠ”ê²ƒì„ ì•Œê²Œ ë˜ì—ˆë‹¤.</p>\n<h2 id=\"ì°¸ê³ \" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"ì°¸ê³  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ì°¸ê³ </h2>\n<ul>\n<li><a href=\"https://cyuu.tistory.com/139\">https://cyuu.tistory.com/139</a></li>\n<li><a href=\"https://brunch.co.kr/@alden/\">https://brunch.co.kr/@alden/</a></li>\n</ul>","excerpt":"ê°œìš”? ìµœê·¼ì— í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ, ë¦¬ëˆ…ìŠ¤ ì»¤ë„ë‹¨ì˜ ì„¤ì •ì— ì˜í•´ ì´ìŠˆê°€ ë°œìƒí•˜ì˜€ë‹¤. ê·¸ë˜ì„œ ì´ë²ˆ ê¸°íšŒì— TCP_TW ì„¤ì •ì— ëŒ€í•´ ì•Œì•„ë³´ê³ ì í•œë‹¤. ì´ì „ì— ì´ìŠˆê°€ ëœ ì„¤ì •ì€ ,  ì˜µì…˜ì´ì—ˆëŠ”ë°, ì´ ì˜µì…˜ë“¤ì€  ìƒíƒœì˜ ì†Œì¼“ì„ ì¬ì‚¬ìš©í•˜ëŠ” ì˜µì…˜ì´ë‹¤. TIME_WAIT? TIME_WAIT ìƒíƒœëŠ” TCP ì—°ê²°ì´ ì¢…ë£Œëœ í›„, ì¼ì • ì‹œê°„ ë™ì•ˆ ìœ ì§€ë˜ëŠ” ìƒíƒœì´ë‹¤. ì´ìŠˆ ìµœê·¼ azure ì˜ ë¥¼ ì„¸íŒ…í•˜ë©´ì„œ ì™¸ë¶€ ìš”ì²­ì— ëŒ€í•œ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•˜ëŠ” ì´ìŠˆê°€ ìˆì—ˆë‹¤. í™˜ê²½ AKSì— í•˜ë‚˜ì˜ íŒŒë“œì— ë‘ê°œì˜ ì»¨í…Œì´ë„ˆë¥¼ ë„ìš´ ìƒíƒœ NAT ê²Œì´íŠ¸ì›¨ì´ë¥¼ ì‚¬ìš© ì´ìŠˆ ì‹œë‚˜ë¦¬ì˜¤ Aì»¨í…Œì´ë„ˆì—ì„œë§Œ ì™¸ë¶€APIë¥¼ í˜¸ì¶œí•˜ë©´ ë°”ë¡œë°”ë¡œ ì‘ë‹µì´ ì˜´ Bì»¨í…Œì´ë„ˆì—ì„œë§Œ ì™¸ë¶€APIë¥¼ í˜¸ì¶œí•˜ë©´ ë°”ë¡œë°”ë¡œ ì‘ë‹µì´ ì˜´ Aì»¨í…Œì´ë„ˆì—ì„œ ì™¸ë¶€APIí˜¸ì¶œ í›„ ë°”ë¡œ Bì»¨í…Œì´ë„ˆì—ì„œ  ì™¸ë¶€APIë¥¼ í˜¸ì¶œí•˜ë©´ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•¨ AKSì´ˆê¸° êµ¬ì„±ì‹œì—ëŠ” í•´ë‹¹ í˜„ìƒì´ ë°œìƒí•˜ì§€ ì•Šì•˜ì—ˆë‹¤.\nê·¸ëŸ°ë°, ì–´ëŠ ìˆœê°„ í•´ë‹¹ í˜„ìƒì´ ë°œìƒí•˜ê¸° ì‹œì‘í–ˆë‹¤. ì„œë²„ êµ¬ì¶•ì„ í•´ì£¼ë˜ ì¸í”„ë¼íŒ€ì—ì„œ â€œtcpâ€¦","frontmatter":{"date":"July 31, 2023","title":"TCP_TW ì˜µì…˜?","categories":"í”„ë¡œê·¸ë˜ë°","author":"wooobo","emoji":"ğŸ”®"},"fields":{"slug":"/network/2023-07-31-tcp-tw/"}},"next":{"id":"6b7a935e-2598-51b1-8611-0d5844b99ab8","html":"<h2 id=\"ë ˆë””ìŠ¤ë¥¼-ì ìš©í•´ë³´ì\" style=\"position:relative;\"><a href=\"#%EB%A0%88%EB%94%94%EC%8A%A4%EB%A5%BC-%EC%A0%81%EC%9A%A9%ED%95%B4%EB%B3%B4%EC%9E%90\" aria-label=\"ë ˆë””ìŠ¤ë¥¼ ì ìš©í•´ë³´ì permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ë ˆë””ìŠ¤ë¥¼ ì ìš©í•´ë³´ì</h2>\n<hr>\n<h2 id=\"ì‹œë‚˜ë¦¬ì˜¤\" style=\"position:relative;\"><a href=\"#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\" aria-label=\"ì‹œë‚˜ë¦¬ì˜¤ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ì‹œë‚˜ë¦¬ì˜¤</h2>\n<p>1. Coupon ì´ ìƒì„± ë ë•Œ, ë°œí–‰ê°¯ìˆ˜ë§Œí¼ CouponTicket(userIdê°€ null ìƒíƒœ)ì„ DBì— ì €ì¥í•œë‹¤.</p>\n<p>2. ì¿ í° ë°œê¸‰, CouponTicketì˜ IDë¥¼ Redisì— ìŒ“ëŠ”ë‹¤.</p>\n<p>3. ì¿ í° ë°°ê¸‰ Redisì— ìŒ“ì´ CouponTicketì„ ê°€ì ¸ì˜¨ë‹¤.</p>\n<ul>\n<li>\n<p>ê°€ì ¸ì˜¨ CouponTicketì´ ì´ë¯¸ userIdê°€ ì •í•´ì ¸ìˆëŠ”ì§€ DBì— í™•ì¸í•˜ê³  ì •í•´ì ¸ ìˆì§€ ì•Šë‹¤ë©´ userIdë¥¼ ë§µí•‘í•˜ê³  ì €ì¥í•œë‹¤.</p>\n</li>\n<li>\n<p>ì¿ í°í‹°ì¼“ ê²°ê³¼ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤.</p>\n</li>\n</ul>\n<h3 id=\"êµ¬í˜„\" style=\"position:relative;\"><a href=\"#%EA%B5%AC%ED%98%84\" aria-label=\"êµ¬í˜„ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>êµ¬í˜„</h3>\n<p>1. Coupon ì´ ìƒì„± ë ë•Œ, ë°œí–‰ê°¯ìˆ˜ë§Œí¼ CouponTicket(userIdê°€ null ìƒíƒœ)ì„ DBì— ì €ì¥í•œë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponController</span> <span class=\"token punctuation\">{</span>\n\t\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    \n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"api/create\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        couponGenerateService<span class=\"token punctuation\">.</span><span class=\"token function\">generate</span><span class=\"token punctuation\">(</span>limit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token operator\">--</span><span class=\"token operator\">-</span>\n\n<span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponGenerateService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponGenerateService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponRepository</span> couponRepository<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponRepository <span class=\"token operator\">=</span> couponRepository<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponTicketRepository <span class=\"token operator\">=</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Coupon</span> coupon <span class=\"token operator\">=</span> <span class=\"token class-name\">Coupon</span><span class=\"token punctuation\">.</span><span class=\"token function\">limitOf</span><span class=\"token punctuation\">(</span>limit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        couponRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>coupon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> couponTickets <span class=\"token operator\">=</span> coupon<span class=\"token punctuation\">.</span><span class=\"token function\">allPublish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">saveAll</span><span class=\"token punctuation\">(</span>couponTickets<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>2. ì¿ í° ë°œê¸‰, CouponTicketì˜ IDë¥¼ Redisì— ìŒ“ëŠ”ë‹¤.</p>\n<p>ì—¬ëŸ¬ ë°©ë²•ì´ ìˆê² ì§€ë§Œ, ìŠ¤ì¼€ì¥´ëŸ¬ë¥¼ ì ìš©í•´ë³´ê¸°ë¡œ í–ˆë‹¤.</p>\n<p>ì¼ì • ê°¯ìˆ˜ ì´í•˜ì¼ë•Œ Redisì— ìŒ“ê¸°.</p>\n<p><strong>Redis ì„¤ì •í•˜ê¸°</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${spring.data.redis.host}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> redisHost<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${spring.data.redis.port}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> redisPort<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisConnectionFactory</span> <span class=\"token function\">redisConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LettuceConnectionFactory</span><span class=\"token punctuation\">(</span>redisHost<span class=\"token punctuation\">,</span> redisPort<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">redisTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token function\">redisConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setKeySerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setValueSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">GenericJackson2JsonRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>ìŠ¤ì¼€ì¥´ëŸ¬ ì ìš©</strong></p>\n<ul>\n<li>1ì´ˆì— í•œë²ˆì”© ì²´í¬</li>\n<li>2000ê°œ ì´í•˜ì¼ë•Œ 10000ê°œì”© ë°€ì–´ ë„£ê²Œ êµ¬í˜„</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponTicketRedisScheduler</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponTicketRedisScheduler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redisTemplate <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponTicketRepository <span class=\"token operator\">=</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Scheduled</span><span class=\"token punctuation\">(</span>fixedDelay <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Long</span> couponId <span class=\"token operator\">=</span> <span class=\"token number\">2L</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">ListOperations</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> valueOperations <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Long</span> remainCount <span class=\"token operator\">=</span> valueOperations<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">generateCouponTicket</span><span class=\"token punctuation\">(</span>remainCount<span class=\"token punctuation\">,</span> couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"finished\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">generateCouponTicket</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> remainCount<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Pageable</span> page <span class=\"token operator\">=</span> <span class=\"token class-name\">Pageable</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">></span></span> couponTickets <span class=\"token operator\">=</span> couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByCouponIdAndUserIdNull</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">,</span> page<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>remainCount <span class=\"token operator\">&lt;</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">ListOperations</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> valueOperations <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> couponTicketIds <span class=\"token operator\">=</span> couponTickets<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponTicket</span><span class=\"token operator\">::</span><span class=\"token function\">getId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            valueOperations<span class=\"token punctuation\">.</span><span class=\"token function\">rightPushAll</span><span class=\"token punctuation\">(</span><span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> couponTicketIds<span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"couponTickets:\"</span> <span class=\"token operator\">+</span> couponId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>3. ì¿ í° ë°°ê¸‰ Redisì— ìŒ“ì´ CouponTicketì„ ê°€ì ¸ì˜¨ë‹¤.</p>\n<p>- ì»¨íŠ¸ë¡¤ëŸ¬</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"api/publish/{userId}/{couponId}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TicketDto</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">CouponTicket</span> couponTicket <span class=\"token operator\">=</span> couponTicketRedis<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>couponTicket <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TicketDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>couponTicket<span class=\"token punctuation\">.</span><span class=\"token function\">getCouponId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TicketDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>- Reids ì—ì„œ ì¿ í° í‹°ì¼“ ê°€ì ¸ì˜¤ê¸° ì„œë¹„ìŠ¤</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CouponTicketRedis</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponTicketRedis</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CouponTicketRepository</span> couponTicketRepository<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redisTemplate <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>couponTicketRepository <span class=\"token operator\">=</span> couponTicketRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CouponTicket</span> <span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span> userId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ListOperations</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> valueOperations <span class=\"token operator\">=</span> redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// í‹°ì¼“ POP</span>\n        <span class=\"token class-name\">CouponTicket</span> couponTicket <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CouponTicket</span><span class=\"token punctuation\">)</span> valueOperations<span class=\"token punctuation\">.</span><span class=\"token function\">leftPop</span><span class=\"token punctuation\">(</span><span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span>couponId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>couponTicket <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NoSuchElementException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ì¿ í°ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// ìœ ì € ì„¸íŒ…</span>\n        couponTicket<span class=\"token punctuation\">.</span><span class=\"token function\">owner</span><span class=\"token punctuation\">(</span>userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// ìœ ì € ì„¸íŒ… í›„ ì €ì¥</span>\n        couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>couponTicket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> couponTicket<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generateKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> couponId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"couponTickets:\"</span> <span class=\"token operator\">+</span> couponId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"ë¶€í•˜-í…ŒìŠ¤íŠ¸\" style=\"position:relative;\"><a href=\"#%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"ë¶€í•˜ í…ŒìŠ¤íŠ¸ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ë¶€í•˜ í…ŒìŠ¤íŠ¸</h2>\n<p>k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸</p>\n<p>- script.js</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token namespace\">http</span> from 'k6<span class=\"token operator\">/</span>http'<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>check<span class=\"token punctuation\">,</span> sleep<span class=\"token punctuation\">}</span> from <span class=\"token char\">'k6'</span><span class=\"token punctuation\">;</span>\n\nexport <span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    stages<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>duration<span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> target<span class=\"token operator\">:</span> <span class=\"token number\">500</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>duration<span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> target<span class=\"token operator\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>duration<span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> target<span class=\"token operator\">:</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>duration<span class=\"token operator\">:</span> <span class=\"token string\">\"10s\"</span><span class=\"token punctuation\">,</span> target<span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    thresholds<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        http_req_duration<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>'<span class=\"token function\">p</span><span class=\"token punctuation\">(</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span><span class=\"token number\">100</span>'<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nexport <span class=\"token keyword\">default</span> function <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>`http<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>localhost<span class=\"token operator\">:</span><span class=\"token number\">8080</span><span class=\"token operator\">/</span>api<span class=\"token operator\">/</span>publish<span class=\"token operator\">/</span>$<span class=\"token punctuation\">{</span><span class=\"token function\">getRandomInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">/</span><span class=\"token number\">2</span>`<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">check</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>'status was <span class=\"token number\">200</span>'<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> r<span class=\"token punctuation\">.</span>status <span class=\"token operator\">==</span><span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nfunction <span class=\"token function\">getRandomInt</span><span class=\"token punctuation\">(</span>min<span class=\"token punctuation\">,</span> max<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    min <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">ceil</span><span class=\"token punctuation\">(</span>min<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    max <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>max <span class=\"token operator\">-</span> min<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> min<span class=\"token punctuation\">;</span> <span class=\"token comment\">//ìµœëŒ“ê°’ì€ ì œì™¸, ìµœì†Ÿê°’ì€ í¬í•¨</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>í…ŒìŠ¤íŠ¸ ê²°ê³¼</strong></p>\n<p><img src=\"../content/series/coupon/coupon-3-01.png\" alt=\"\"></p>\n<p>í‰ê·  100ms ì´í•˜ë¡œ ë‚˜ì™”ë‹¤.</p>\n<p>ì§€ì—°ë˜ëŠ” ë¶€ë¶„ì€</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">        <span class=\"token comment\">// ìœ ì € ì„¸íŒ… í›„ ì €ì¥</span>\n        couponTicketRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>couponTicket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"db-pool-size-ì¡°ì •í•´ë³´ë©´-ì–´ë–¨ê¹Œ\" style=\"position:relative;\"><a href=\"#db-pool-size-%EC%A1%B0%EC%A0%95%ED%95%B4%EB%B3%B4%EB%A9%B4-%EC%96%B4%EB%96%A8%EA%B9%8C\" aria-label=\"db pool size ì¡°ì •í•´ë³´ë©´ ì–´ë–¨ê¹Œ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DB POOL SIZE ì¡°ì •í•´ë³´ë©´ ì–´ë–¨ê¹Œ?</h2>\n<p>ë¬¸ë“ DB ì»¤ë„¥ì…˜ POOLì„ ëŠ˜ë¦¬ë©´ ë¹¨ë¼ì§€ì§€ ì¢€ ë” ìµœì í™” í•  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ ìƒê°ì´ ë˜ì—ˆë‹¤.</p>\n<p>ì„¤ì •ì„ ì¶”ê°€í–ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">spring.datasource.hikari.maximum-pool-size</span><span class=\"token punctuation\">:</span> <span class=\"token number\">100</span></code></pre></div>\n<p>ê·¸ë¦¬ê³  pool size ë¥¼ ë‚˜ëˆ„ì–´ í…ŒìŠ¤íŠ¸ í•´ë³´ì•˜ë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\"><span class=\"token title important\"><span class=\"token punctuation\">#</span> DB pool size 25</span>\navg=403.13ms min=2.63ms med=521.26ms max=999.98ms p(90)=712.01ms p(95)=755.75ms\navg=453.87ms min=2.79ms med=584.58ms max=1.17s   p(90)=808.83ms p(95)=942.38ms\navg=430.86ms min=2.79ms med=564.97ms max=1.24s    p(90)=861.28ms p(95)=947.41ms\n\n<span class=\"token title important\"><span class=\"token punctuation\">#</span> DB pool size 50</span>\navg=327.05ms min=2.65ms med=354.36ms max=1.62s   p(90)=634.81ms p(95)=1.07s\navg=167.88ms min=2.33ms med=192.51ms max=580.31ms p(90)=329.93ms p(95)=395.59ms\navg=229.95ms min=2.6ms  med=312.7ms  max=686.1ms  p(90)=431.14ms p(95)=460.81ms\n\n<span class=\"token title important\"><span class=\"token punctuation\">#</span> DB pool size 75</span>\navg=295.76ms min=3.05ms med=327.56ms max=927.11ms p(90)=614.81ms p(95)=676.6ms\n\n<span class=\"token title important\"><span class=\"token punctuation\">#</span> DB pool size 100</span>\navg=178.74ms min=2.55ms med=208.44ms max=560.36ms p(90)=342.46ms p(95)=376.09ms\navg=163.61ms min=2.71ms med=133.92ms max=626.94ms p(90)=374.09ms p(95)=451.05ms\navg=205.32ms min=1.11ms med=215.16ms max=708.67ms p(90)=426.21ms p(95)=503.23ms</code></pre></div>\n<p>ë‚˜ë¦„ ìœ ì˜ë¯¸í•œ ê²°ê³¼ê°€ ë‚˜ì™”ë‹¤.<br>\ní˜„ì¬ ë¡œì»¬ êµ¬ì¡°ëŠ” <code class=\"language-text\">docker Mysql</code>, <code class=\"language-text\">docker Redis</code>, <code class=\"language-text\">Local Spring boot Server</code> ì´ë‹¤.<br>\nPCëŠ” ë§¥ë¶ ì—ì–´ m2ì´ë‹¤.</p>\n<p>í˜„ì¬ ì‚¬ì–‘ì—ì„œëŠ” DB pool size 100 ì¼ë•Œ ê°€ì¥ ìµœì í™”ëœê²ƒìœ¼ë¡œ í™•ì¸ë˜ì—ˆë‹¤.<br>\npool size ë¥¼ ë” ëŠ˜ë ¤ë³´ì•˜ì§€ë§Œ, DB ì‚¬ì–‘ í•œê³„ì¹˜ê°€ ìˆì–´ì„œì¸ì§€ ê·¸ì´ìƒì€ ì˜¤íˆë ¤ ëŠë ¤ì¡Œë‹¤.</p>\n<p><strong>ì„œë²„ ìŠ¤ë ˆë“œ ëŠ˜ë¦¬ë©´?</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"md\"><pre class=\"language-md\"><code class=\"language-md\">server.tomcat.threads.max=20\n\nDB pool size 50, tomcat threads 20\navg=464.32ms min=2.6ms  med=623.78ms max=882.89ms p(90)=821.75ms p(95)=838.93ms\navg=496.68ms min=2.68ms med=649.88ms max=987.8ms  p(90)=866.58ms p(95)=934.47ms\navg=539.1ms  min=2.77ms med=553.2ms  max=1.35s   p(90)=1.08s p(95)=1.15s</code></pre></div>\n<p>ì–´ì°¨í”¼ DBì˜ í•œê³„ ë•Œë¬¸ì— <code class=\"language-text\">input</code> ì„ ë§ˆëƒ¥ ë§ì´ ë°›ëŠ”ê²Œ ë‹µì€ ì•„ë‹Œê²ƒ ê°™ë‹¤.</p>\n<h2 id=\"ì •ë¦¬\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"ì •ë¦¬ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ì •ë¦¬</h2>\n<p>(1) ì—ì„œëŠ” ë¡œì»¬ ì‹œìŠ¤í…œ ë§Œìœ¼ë¡œ ì¿ í° ë„ë©”ì¸ ë¡œì§ê³¼ ë™ì‹œì„± ì´ìŠˆì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì•˜ê³ ,<br>\n(2) ì—ì„œëŠ” ì›¹ ì„œë²„ë¡œ ì˜¬ë ¤ì„œ ë¶€í•˜í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì•˜ë‹¤. ì´ë²¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ DB save ë¡œì§ì„ ë¶„ë¦¬í•´ë³´ì•˜ë‹¤.<br>\n(3) ë‹¤ì¤‘ ì„œë²„ì¼ë•Œì˜ í™˜ê²½ì„ ê³ ë ¤í•´ì„œ Redis ë¥¼ ì ìš©í•´ë³´ê³  í…ŒìŠ¤íŠ¸ ê¹Œì§€ ì§„í–‰í•´ë³´ì•˜ë‹¤.</p>\n<hr>\n<blockquote>\n<p>ì—¬ëŸ¬ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒê°í•˜ë©° ì§„í–‰í•´ë³¸ ì‘ì—…ì´ì—ˆëŠ”ë° ì¬ë¯¸ìˆì—ˆë‹¤.</p>\n</blockquote>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%A0%88%EB%94%94%EC%8A%A4%EB%A5%BC-%EC%A0%81%EC%9A%A9%ED%95%B4%EB%B3%B4%EC%9E%90\">ë ˆë””ìŠ¤ë¥¼ ì ìš©í•´ë³´ì</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4\">ì‹œë‚˜ë¦¬ì˜¤</a></p>\n<ul>\n<li><a href=\"#%EA%B5%AC%ED%98%84\">êµ¬í˜„</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%B6%80%ED%95%98-%ED%85%8C%EC%8A%A4%ED%8A%B8\">ë¶€í•˜ í…ŒìŠ¤íŠ¸</a></p>\n</li>\n<li>\n<p><a href=\"#db-pool-size-%EC%A1%B0%EC%A0%95%ED%95%B4%EB%B3%B4%EB%A9%B4-%EC%96%B4%EB%96%A8%EA%B9%8C\">DB POOL SIZE ì¡°ì •í•´ë³´ë©´ ì–´ë–¨ê¹Œ?</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%A0%95%EB%A6%AC\">ì •ë¦¬</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"May 23, 2023","title":"ì¿ í° ë°œê¸‰ (3) - ë ˆë””ìŠ¤ ì ìš©","categories":"ì‹œë¦¬ì¦ˆ","author":"wooobo","emoji":"3ï¸âƒ£"},"fields":{"slug":"/series/coupon/coupon3/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://wooobo.github.io","comments":{"utterances":{"repo":""}}}}},"pageContext":{"slug":"/network/2023-07-31-tcp-tw/","nextSlug":"/series/coupon/coupon3/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}